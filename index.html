<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassPay - ระบบเก็บเงินห้อง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK v9+ Modular -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, update, onValue, serverTimestamp, query, orderByChild, orderByKey } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCzcmMd8R2RKqI8Km4aN_-3ys3HFoywHrA",
            authDomain: "money-8b7a7.firebaseapp.com",
            databaseURL: "https://money-8b7a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "money-8b7a7",
            storageBucket: "money-8b7a7.firebasestorage.app",
            messagingSenderId: "61510377024",
            appId: "1:61510377024:web:5cc70cdc363b83f9d589a5",
            measurementId: "G-6H493LQ24N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        // Make Firebase services available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAnalytics = analytics;
        
        // Make Firebase functions available globally
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.push = push;
        window.update = update;
        window.onValue = onValue;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.orderByChild = orderByChild;
        window.orderByKey = orderByKey;

        console.log('Firebase Realtime Database v12 initialized successfully!');
    </script>
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .glass-effect { 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .btn-glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(102, 126, 234, 0.6); }
        .floating-animation { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect backdrop-blur-lg border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">ClassPay</h1>
                        <p class="text-xs text-gray-500">ระบบเก็บเงินอัจฉริยะ</p>
                    </div>
                </div>
                <div id="navButtons" class="flex space-x-3">
                    <button onclick="showLogin()" class="px-6 py-2 bg-white/20 hover:bg-white/30 text-purple-700 rounded-xl transition-all duration-300 backdrop-blur-sm border border-white/30">
                        เข้าสู่ระบบ
                    </button>
                    <button onclick="showRegister()" class="px-6 py-2 gradient-primary text-white rounded-xl hover:shadow-lg transition-all duration-300 btn-glow">
                        สมัครสมาชิกครู
                    </button>
                </div>
                <div id="userMenu" class="hidden flex items-center space-x-4">
                    <div class="text-right">
                        <p id="welcomeText" class="font-medium text-gray-700"></p>
                        <p class="text-xs text-gray-500" id="userRole"></p>
                    </div>
                    <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full pulse" title="เชื่อมต่อ Firebase"></div>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-all duration-300 shadow-lg">
                        ออกจากระบบ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="text-center slide-in">
            <div class="max-w-4xl mx-auto">
                <div class="floating-animation text-8xl mb-8">
                    <i class="fas fa-coins text-purple-600"></i>
                </div>
                <h2 class="text-5xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 bg-clip-text text-transparent mb-6">
                    ยินดีต้อนรับสู่ ClassPay
                </h2>
                <p class="text-xl text-gray-600 mb-12 max-w-2xl mx-auto leading-relaxed">
                    ระบบเก็บเงินห้องเรียนที่ทันสมัย ใช้งานง่าย และปลอดภัย พร้อมระบบแจ้งเตือนแบบเรียลไทม์
                </p>
                
                <div class="grid md:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white/60 backdrop-blur-lg p-8 rounded-2xl shadow-xl card-hover border border-white/20">
                        <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-6 shadow-lg">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">สำหรับครู/เหรัญญิก</h3>
                        <p class="text-gray-600 leading-relaxed">จัดการข้อมูลนักเรียน กำหนดสัปดาห์การจ่าย และตรวจสอบการชำระเงินแบบเรียลไทม์</p>
                    </div>
                    <div class="bg-white/60 backdrop-blur-lg p-8 rounded-2xl shadow-xl card-hover border border-white/20">
                        <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-6 shadow-lg">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">สำหรับนักเรียน</h3>
                        <p class="text-gray-600 leading-relaxed">ตรวจสอบสถานะการจ่ายเงิน ดูประวัติการชำระ โดยใช้รหัสนักเรียนเข้าสู่ระบบ</p>
                    </div>
                    <div class="bg-white/60 backdrop-blur-lg p-8 rounded-2xl shadow-xl card-hover border border-white/20">
                        <div class="w-16 h-16 gradient-success rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-6 shadow-lg">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">รายงานแบบเรียลไทม์</h3>
                        <p class="text-gray-600 leading-relaxed">ดูสถิติการจ่ายเงิน กราฟแสดงผล และส่งออกรายงานได้ทันที</p>
                    </div>
                </div>

                <!-- How to Use Section -->
                <div class="bg-white/60 backdrop-blur-lg rounded-3xl shadow-xl p-8 mb-12 border border-white/20">
                    <div class="text-center mb-12">
                        <div class="w-20 h-20 gradient-success rounded-3xl flex items-center justify-center text-white text-4xl mx-auto mb-6 shadow-xl floating-animation">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <h3 class="text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 bg-clip-text text-transparent mb-4">
                            วิธีการใช้งาน ClassPay
                        </h3>
                        <p class="text-gray-600 text-xl max-w-2xl mx-auto leading-relaxed">
                            เริ่มต้นใช้งานระบบเก็บเงินห้องเรียนที่ทันสมัยและใช้งานง่าย
                        </p>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="flex justify-center mb-10">
                        <div class="flex space-x-2 bg-gray-100 rounded-2xl p-2">
                            <button onclick="switchGuideTab('teacher')" id="teacherGuideTab" class="px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 bg-white text-purple-600 shadow-lg">
                                <i class="fas fa-chalkboard-teacher mr-3"></i>สำหรับครู
                            </button>
                            <button onclick="switchGuideTab('student')" id="studentGuideTab" class="px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 text-gray-600 hover:text-purple-600">
                                <i class="fas fa-user-graduate mr-3"></i>สำหรับนักเรียน
                            </button>
                        </div>
                    </div>

                    <!-- Teacher Guide -->
                    <div id="teacherGuide" class="space-y-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h4 class="text-3xl font-bold text-gray-800 mb-2">คู่มือสำหรับครูและเหรัญญิก</h4>
                            <p class="text-gray-600 text-lg">จัดการระบบเก็บเงินห้องอย่างมีประสิทธิภาพ</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Step 1 -->
                            <div class="group bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 border-2 border-purple-200 hover:border-purple-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        1
                                    </div>
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-plus text-purple-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">สมัครสมาชิก</h5>
                                <p class="text-gray-600 leading-relaxed">ใช้อีเมลและรหัสผ่านในการสมัครสมาชิกครู เพื่อเริ่มต้นใช้งานระบบ</p>
                                <div class="mt-4 flex items-center text-purple-600 text-sm font-medium">
                                    <i class="fas fa-clock mr-2"></i>
                                    <span>ใช้เวลา 2 นาที</span>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="group bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border-2 border-blue-200 hover:border-blue-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        2
                                    </div>
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">เพิ่มนักเรียน</h5>
                                <p class="text-gray-600 leading-relaxed">เพิ่มรายชื่อนักเรียนทีละคน หรือนำเข้าจาก Excel พร้อมกำหนดรหัสผ่าน</p>
                                <div class="mt-4 flex items-center text-blue-600 text-sm font-medium">
                                    <i class="fas fa-file-excel mr-2"></i>
                                    <span>รองรับ Excel Import</span>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="group bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border-2 border-indigo-200 hover:border-indigo-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        3
                                    </div>
                                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-plus text-indigo-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">กำหนดสัปดาห์</h5>
                                <p class="text-gray-600 leading-relaxed">ตั้งค่าสัปดาห์การจ่ายและจำนวนเงินที่ต้องเก็บในแต่ละสัปดาห์</p>
                                <div class="mt-4 flex items-center text-indigo-600 text-sm font-medium">
                                    <i class="fas fa-coins mr-2"></i>
                                    <span>กำหนดจำนวนเงินได้</span>
                                </div>
                            </div>

                            <!-- Step 4 -->
                            <div class="group bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border-2 border-green-200 hover:border-green-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        4
                                    </div>
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-check-circle text-green-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">จัดการการจ่าย</h5>
                                <p class="text-gray-600 leading-relaxed">อัพเดทสถานะการจ่ายเงินของนักเรียน พร้อมระบุจำนวนเงินที่จ่ายจริง</p>
                                <div class="mt-4 flex items-center text-green-600 text-sm font-medium">
                                    <i class="fas fa-sync mr-2"></i>
                                    <span>อัพเดทแบบเรียลไทม์</span>
                                </div>
                            </div>

                            <!-- Step 5 -->
                            <div class="group bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-6 border-2 border-emerald-200 hover:border-emerald-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        5
                                    </div>
                                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-wallet text-emerald-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">จัดการเงินห้อง</h5>
                                <p class="text-gray-600 leading-relaxed">บันทึกการใช้จ่าย ติดตามยอดเงินคงเหลือ และดูประวัติการใช้เงิน</p>
                                <div class="mt-4 flex items-center text-emerald-600 text-sm font-medium">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    <span>รายงานแบบเรียลไทม์</span>
                                </div>
                            </div>

                            <!-- Step 6 -->
                            <div class="group bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl p-6 border-2 border-orange-200 hover:border-orange-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-110 transition-transform">
                                        6
                                    </div>
                                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-crown text-orange-600 text-lg"></i>
                                    </div>
                                </div>
                                <h5 class="text-xl font-bold text-gray-800 mb-3">กำหนดเหรัญญิก</h5>
                                <p class="text-gray-600 leading-relaxed">เลือกนักเรียนเป็นเหรัญญิก เพื่อช่วยจัดการระบบเก็บเงินห้อง</p>
                                <div class="mt-4 flex items-center text-orange-600 text-sm font-medium">
                                    <i class="fas fa-user-shield mr-2"></i>
                                    <span>สิทธิ์พิเศษสำหรับเหรัญญิก</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Guide -->
                    <div id="studentGuide" class="hidden space-y-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h4 class="text-3xl font-bold text-gray-800 mb-2">คู่มือสำหรับนักเรียน</h4>
                            <p class="text-gray-600 text-lg">ตรวจสอบสถานะการจ่ายเงินและประวัติการชำระ</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            <!-- Step 1 -->
                            <div class="group bg-gradient-to-br from-pink-50 to-rose-50 rounded-2xl p-8 border-2 border-pink-200 hover:border-pink-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg group-hover:scale-110 transition-transform">
                                        1
                                    </div>
                                    <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-id-card text-pink-600 text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-2xl font-bold text-gray-800 mb-4">รับข้อมูลเข้าสู่ระบบ</h5>
                                <p class="text-gray-600 leading-relaxed mb-4">ครูจะแจ้งรหัสนักเรียนและรหัสผ่านให้ เพื่อใช้ในการเข้าสู่ระบบ</p>
                                <div class="bg-pink-100 rounded-xl p-4">
                                    <div class="flex items-center text-pink-700 text-sm font-medium mb-2">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        <span>ข้อมูลที่ต้องได้รับ:</span>
                                    </div>
                                    <ul class="text-pink-600 text-sm space-y-1 ml-4">
                                        <li>• รหัสนักเรียน (เช่น 65001)</li>
                                        <li>• รหัสผ่าน (เริ่มต้น: 123456)</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="group bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl p-8 border-2 border-rose-200 hover:border-rose-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg group-hover:scale-110 transition-transform">
                                        2
                                    </div>
                                    <div class="w-12 h-12 bg-rose-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-sign-in-alt text-rose-600 text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-2xl font-bold text-gray-800 mb-4">เข้าสู่ระบบ</h5>
                                <p class="text-gray-600 leading-relaxed mb-4">ใช้รหัสนักเรียนและรหัสผ่านที่ได้รับจากครูเพื่อเข้าสู่ระบบ</p>
                                <div class="bg-rose-100 rounded-xl p-4">
                                    <div class="flex items-center text-rose-700 text-sm font-medium mb-2">
                                        <i class="fas fa-lightbulb mr-2"></i>
                                        <span>เคล็ดลับ:</span>
                                    </div>
                                    <p class="text-rose-600 text-sm">เลือกแท็บ "นักเรียน" ในหน้าเข้าสู่ระบบ</p>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="group bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-8 border-2 border-purple-200 hover:border-purple-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg group-hover:scale-110 transition-transform">
                                        3
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-search text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-2xl font-bold text-gray-800 mb-4">ตรวจสอบสถานะ</h5>
                                <p class="text-gray-600 leading-relaxed mb-4">ดูสถานะการจ่ายเงินสัปดาห์ปัจจุบัน และข้อมูลการเงินของห้อง</p>
                                <div class="bg-purple-100 rounded-xl p-4">
                                    <div class="flex items-center text-purple-700 text-sm font-medium mb-2">
                                        <i class="fas fa-eye mr-2"></i>
                                        <span>สิ่งที่จะเห็น:</span>
                                    </div>
                                    <ul class="text-purple-600 text-sm space-y-1 ml-4">
                                        <li>• สถานะการจ่ายเงิน</li>
                                        <li>• จำนวนเงินที่ต้องจ่าย</li>
                                        <li>• สรุปเงินห้องทั้งหมด</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Step 4 -->
                            <div class="group bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-8 border-2 border-blue-200 hover:border-blue-300 transition-all duration-300 hover:shadow-xl card-hover">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg group-hover:scale-110 transition-transform">
                                        4
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-history text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-2xl font-bold text-gray-800 mb-4">ดูประวัติการจ่าย</h5>
                                <p class="text-gray-600 leading-relaxed mb-4">ตรวจสอบประวัติการชำระเงินที่ผ่านมา และยอดรวมที่จ่ายแล้ว</p>
                                <div class="bg-blue-100 rounded-xl p-4">
                                    <div class="flex items-center text-blue-700 text-sm font-medium mb-2">
                                        <i class="fas fa-chart-bar mr-2"></i>
                                        <span>ข้อมูลประวัติ:</span>
                                    </div>
                                    <ul class="text-blue-600 text-sm space-y-1 ml-4">
                                        <li>• รายการจ่ายแต่ละสัปดาห์</li>
                                        <li>• วันที่ชำระเงิน</li>
                                        <li>• ยอดรวมที่จ่ายทั้งหมด</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Tips Section -->
                    <div class="mt-12 p-8 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-3xl border-2 border-blue-200">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h5 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-2">
                                เคล็ดลับและข้อดีของ ClassPay
                            </h5>
                            <p class="text-gray-600">สิ่งที่ทำให้ ClassPay เป็นระบบเก็บเงินที่ดีที่สุด</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/50 hover:shadow-lg transition-all card-hover">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-cloud text-green-600 text-xl"></i>
                                </div>
                                <h6 class="font-bold text-gray-800 mb-2">บันทึกแบบเรียลไทม์</h6>
                                <p class="text-gray-600 text-sm">ข้อมูลจะถูกบันทึกทันที ไม่ต้องกังวลเรื่องข้อมูลหาย</p>
                            </div>
                            
                            <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/50 hover:shadow-lg transition-all card-hover">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-mobile-alt text-blue-600 text-xl"></i>
                                </div>
                                <h6 class="font-bold text-gray-800 mb-2">ใช้งานได้ทุกอุปกรณ์</h6>
                                <p class="text-gray-600 text-sm">รองรับทั้งมือถือ แท็บเล็ต และคอมพิวเตอร์</p>
                            </div>
                            
                            <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/50 hover:shadow-lg transition-all card-hover">
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-crown text-purple-600 text-xl"></i>
                                </div>
                                <h6 class="font-bold text-gray-800 mb-2">ระบบเหรัญญิก</h6>
                                <p class="text-gray-600 text-sm">เหรัญญิกมีสิทธิ์พิเศษ ช่วยครูจัดการระบบได้</p>
                            </div>
                            
                            <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/50 hover:shadow-lg transition-all card-hover">
                                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-file-excel text-orange-600 text-xl"></i>
                                </div>
                                <h6 class="font-bold text-gray-800 mb-2">นำเข้า Excel</h6>
                                <p class="text-gray-600 text-sm">เพิ่มนักเรียนหลายคนพร้อมกันจาก Excel</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button onclick="showLogin()" class="px-8 py-4 gradient-primary text-white rounded-2xl hover:shadow-2xl transition-all duration-300 btn-glow font-medium">
                        เริ่มใช้งานเลย
                    </button>
                    <button onclick="showRegister()" class="px-8 py-4 bg-white/60 backdrop-blur-lg text-purple-700 rounded-2xl hover:shadow-xl transition-all duration-300 border border-white/30">
                        สมัครสมาชิกครู
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="hidden max-w-lg mx-auto slide-in">
            <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/20">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-4 shadow-lg">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800">เข้าสู่ระบบ</h2>
                    <p class="text-gray-600 mt-2">ยินดีต้อนรับกลับมา!</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="flex space-x-1 mb-8 bg-gray-100 rounded-xl p-1">
                    <button onclick="switchLoginTab('teacher')" id="teacherLoginTab" class="flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all bg-white text-purple-600 shadow-sm">
                        <i class="fas fa-chalkboard-teacher mr-2"></i>ครู/เหรัญญิก
                    </button>
                    <button onclick="switchLoginTab('student')" id="studentLoginTab" class="flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600">
                        <i class="fas fa-user-graduate mr-2"></i>นักเรียน
                    </button>
                </div>

                <!-- Teacher Login Form -->
                <div id="teacherLoginForm" class="space-y-6">
                    <form onsubmit="handleTeacherLogin(event)" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">อีเมล</label>
                            <input type="email" id="teacherEmail" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="teacher@school.com" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่าน</label>
                            <input type="password" id="teacherPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="••••••••" required>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-blue-800 text-sm">
                                <strong><i class="fas fa-info-circle mr-1"></i> สำหรับครู:</strong> ใช้อีเมลและรหัสผ่านที่สมัครไว้
                            </p>
                        </div>
                        <button type="submit" id="teacherLoginBtn" class="w-full py-4 gradient-primary text-white rounded-xl hover:shadow-xl transition-all duration-300 btn-glow font-medium text-lg">
                            <i class="fas fa-chalkboard-teacher mr-2"></i> เข้าสู่ระบบครู
                        </button>
                    </form>
                    <p class="text-center mt-6 text-gray-600">
                        ยังไม่มีบัญชีครู? <button onclick="showRegister()" class="text-purple-600 hover:text-purple-700 font-medium">สมัครสมาชิกครู</button>
                    </p>
                </div>

                <!-- Student Login Form -->
                <div id="studentLoginForm" class="hidden space-y-6">
                    <form onsubmit="handleStudentLogin(event)" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">รหัสนักเรียน</label>
                            <input type="text" id="studentId" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" placeholder="65001" required>
                        </div>
                        <div id="studentPasswordField" class="hidden">
                            <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่าน (ถ้ามี)</label>
                            <input type="password" id="studentPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" placeholder="••••••••">
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <p class="text-green-800 text-sm">
                                <strong><i class="fas fa-info-circle mr-1"></i> สำหรับนักเรียน:</strong> ใส่เฉพาะรหัสนักเรียนเพื่อเข้าสู่ระบบ
                            </p>
                            <p class="text-green-600 text-xs mt-2">
                                • รหัสนักเรียนจะได้รับจากครูผู้สอน<br>
                                • ไม่ต้องใส่รหัสผ่าน (ระบบใหม่)
                            </p>
                        </div>
                        <button type="submit" id="studentLoginBtn" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl hover:shadow-xl transition-all duration-300 font-medium text-lg">
                            <i class="fas fa-user-graduate mr-2"></i> เข้าสู่ระบบนักเรียน
                        </button>
                    </form>
                    <p class="text-center mt-6 text-gray-600 text-sm">
                        <i class="fas fa-question-circle mr-1"></i> ไม่ทราบรหัสนักเรียน? ติดต่อครูผู้สอนของคุณ
                    </p>
                </div>
            </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="hidden max-w-md mx-auto slide-in">
            <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/20">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-4 shadow-lg">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800">สมัครสมาชิกครู</h2>
                    <p class="text-gray-600 mt-2">สำหรับครูผู้สอนและเหรัญญิกเท่านั้น</p>
                </div>
                <form onsubmit="handleRegister(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">ชื่อ-นามสกุล</label>
                        <input type="text" id="registerName" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="ชื่อ นามสกุล ครู" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">อีเมล</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="teacher@school.com" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่าน</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="••••••••" required>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-blue-800 text-sm">
                            <strong><i class="fas fa-info-circle mr-1"></i> หมายเหตุ:</strong> บัญชีนี้สำหรับครูเท่านั้น นักเรียนจะใช้รหัสนักเรียนเข้าสู่ระบบ
                        </p>
                    </div>
                    <div id="firebaseStatus" class="bg-orange-50 border border-orange-200 rounded-xl p-4">
                        <p class="text-orange-800 text-sm">
                            <strong><i class="fas fa-exclamation-triangle mr-1"></i> Firebase:</strong> 
                            <span id="firebaseStatusText">กำลังตรวจสอบการเชื่อมต่อ...</span>
                        </p>
                        <div class="text-orange-600 text-xs mt-2 space-y-1">
                            <p><strong>หากได้รับข้อผิดพลาด "Missing or insufficient permissions":</strong></p>
                            <p>• ตรวจสอบ Firebase Security Rules ใน Firestore Database</p>
                            <p>• เปลี่ยน Rules เป็น: <code class="bg-orange-100 px-1 rounded">allow read, write: if true;</code></p>
                            <p>• หรือตั้งค่า Authentication และ Rules ให้ถูกต้อง</p>
                        </div>
                    </div>
                    <button type="submit" id="registerBtn" class="w-full py-4 gradient-secondary text-white rounded-xl hover:shadow-xl transition-all duration-300 font-medium text-lg">
                        สมัครสมาชิกครู
                    </button>
                </form>
                <p class="text-center mt-6 text-gray-600">
                    มีบัญชีแล้ว? <button onclick="showLogin()" class="text-purple-600 hover:text-purple-700 font-medium">เข้าสู่ระบบ</button>
                </p>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden slide-in">
            <!-- Header Section -->
            <div class="relative overflow-hidden bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 rounded-3xl shadow-2xl mb-8">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative p-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">แดชบอร์ดผู้ดูแล</h2>
                            <p class="text-purple-100 text-lg">จัดการระบบเก็บเงินห้องอย่างมีประสิทธิภาพ</p>
                        </div>
                        <div class="hidden md:block">
                            <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i class="fas fa-chart-line text-white text-3xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        <div id="treasurerPasswordBtnAdmin" class="hidden">
                            <button onclick="openChangePasswordModal()" class="px-6 py-3 bg-white/20 hover:bg-white/30 text-white rounded-xl transition-all duration-300 backdrop-blur-sm border border-white/30">
                                <i class="fas fa-key mr-2"></i> เปลี่ยนรหัสผ่าน
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Decorative Elements -->
                <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/5 rounded-full"></div>
            </div>

            <!-- Stats Cards -->
            <div class="grid lg:grid-cols-5 gap-6 mb-8">
                <div class="group bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl card-hover border border-white/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-purple-100 opacity-50"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-purple-600" id="totalStudents">0</p>
                                <p class="text-sm font-medium text-purple-500">คน</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">นักเรียนทั้งหมด</h3>
                        <p class="text-sm text-gray-600 mt-1">จำนวนนักเรียนในระบบ</p>
                    </div>
                </div>
                
                <div class="group bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl card-hover border border-white/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-green-100 opacity-50"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-green-600" id="paidStudents">0</p>
                                <p class="text-sm font-medium text-green-500">คน</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">จ่ายแล้ว</h3>
                        <p class="text-sm text-gray-600 mt-1">ชำระเงินแล้ว</p>
                    </div>
                </div>
                
                <div class="group bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl card-hover border border-white/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-red-50 to-red-100 opacity-50"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-clock text-white text-xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-red-600" id="unpaidStudents">0</p>
                                <p class="text-sm font-medium text-red-500">คน</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">ยังไม่จ่าย</h3>
                        <p class="text-sm text-gray-600 mt-1">รอการชำระ</p>
                    </div>
                </div>
                
                <div class="group bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl card-hover border border-white/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 opacity-50"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-coins text-white text-xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-blue-600" id="totalAmount">0</p>
                                <p class="text-sm font-medium text-blue-500">บาท</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">ยอดเงินรวม</h3>
                        <p class="text-sm text-gray-600 mt-1">เงินที่เก็บได้</p>
                    </div>
                </div>
                
                <div class="group bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl card-hover border border-white/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-emerald-50 to-emerald-100 opacity-50"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-wallet text-white text-xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-emerald-600" id="balanceAmount">0</p>
                                <p class="text-sm font-medium text-emerald-500">บาท</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">เงินคงเหลือ</h3>
                        <p class="text-sm text-gray-600 mt-1">เงินที่ใช้ได้</p>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column - Week Management & Student Actions -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Week Management Card -->
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-blue-500 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-calendar-alt mr-3"></i>
                                จัดการสัปดาห์การจ่าย
                            </h3>
                            <p class="text-purple-100 text-sm mt-1">เลือกและจัดการสัปดาห์การเก็บเงิน</p>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-3">เลือกสัปดาห์การจ่าย</label>
                                <select id="weekSelector" onchange="selectWeek()" class="w-full px-4 py-3 bg-white/70 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all font-medium">
                                    <option value="">-- เลือกสัปดาห์การจ่าย --</option>
                                </select>
                            </div>
                            
                            <div id="selectedWeekInfo" class="hidden p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-bold text-blue-800 text-lg" id="selectedWeekText">-</p>
                                        <p class="text-blue-600 font-medium" id="selectedWeekAmount">-</p>
                                    </div>
                                    <div class="flex space-x-1">
                                        <button onclick="editSelectedWeek()" class="w-8 h-8 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="แก้ไขสัปดาห์">
                                            <i class="fas fa-edit text-xs"></i>
                                        </button>
                                        <button onclick="deleteSelectedWeek()" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="ลบสัปดาห์">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="openWeekModal()" class="w-full py-4 gradient-primary text-white rounded-xl hover:shadow-xl transition-all duration-300 btn-glow font-semibold text-lg">
                                <i class="fas fa-calendar-plus mr-2"></i> เพิ่มสัปดาห์ใหม่
                            </button>
                        </div>
                    </div>

                    <!-- Student Management Card (Hidden for Treasurer) -->
                    <div id="studentManagementCard" class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-pink-500 to-rose-500 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-user-graduate mr-3"></i>
                                จัดการนักเรียน
                            </h3>
                            <p class="text-pink-100 text-sm mt-1">เพิ่ม แก้ไข และลบข้อมูลนักเรียน</p>
                        </div>
                        <div class="p-6 space-y-4">
                            <button onclick="openStudentModal()" class="w-full py-4 gradient-secondary text-white rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-lg">
                                <i class="fas fa-user-plus mr-2"></i> เพิ่มนักเรียน
                            </button>
                            <button onclick="openStudentManagementModal()" class="w-full py-4 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-lg">
                                <i class="fas fa-users-cog mr-2"></i> แก้ไข/ลบนักเรียน
                            </button>
                        </div>
                    </div>

                    <!-- Money Management Card -->
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-wallet mr-3"></i>
                                จัดการเงินห้อง
                            </h3>
                            <p class="text-emerald-100 text-sm mt-1">ถอนเงินและจัดการค่าใช้จ่าย</p>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-green-700">เงินคงเหลือ</span>
                                    <span class="text-2xl font-bold text-green-800" id="remainingBalance">0</span>
                                </div>
                                <div class="text-xs text-green-600">
                                    <span>รับเข้า: <span id="totalIncome" class="font-medium">0</span> บาท</span>
                                    <span class="mx-2">•</span>
                                    <span>จ่ายออก: <span id="totalExpense" class="font-medium">0</span> บาท</span>
                                </div>
                            </div>
                            
                            <button onclick="openWithdrawModal()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-lg">
                                <i class="fas fa-money-bill-wave mr-2"></i> ถอนเงิน/ใช้จ่าย
                            </button>
                            <button onclick="showExpenseHistory()" class="w-full py-4 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-lg">
                                <i class="fas fa-history mr-2"></i> ประวัติการใช้เงิน
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Students List -->
                <div class="lg:col-span-2">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-2xl font-bold text-white flex items-center">
                                        <i class="fas fa-list-ul mr-3"></i>
                                        รายชื่อนักเรียน
                                    </h3>
                                    <p class="text-indigo-100 text-sm mt-1">ตรวจสอบและอัพเดทสถานะการจ่ายเงิน</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-white/90 text-sm font-medium" id="studentsListStatus">เลือกสัปดาห์การจ่ายก่อน</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4" id="studentsTable">
                                <div class="py-16 px-6 text-center text-gray-500" id="noWeekSelected">
                                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <i class="fas fa-calendar-times text-gray-400 text-3xl"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-700 mb-2">กรุณาเลือกสัปดาห์การจ่ายก่อน</h4>
                                    <p class="text-gray-500">เลือกสัปดาห์จากด้านซ้ายเพื่อดูรายชื่อนักเรียนและจัดการการจ่ายเงิน</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expense History Dashboard -->
        <div id="expenseHistoryDashboard" class="hidden slide-in">
            <!-- Header Section -->
            <div class="relative overflow-hidden bg-gradient-to-br from-emerald-600 via-teal-600 to-cyan-700 rounded-3xl shadow-2xl mb-8">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative p-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">ประวัติการใช้เงิน</h2>
                            <p class="text-emerald-100 text-lg">รายการถอนเงินและค่าใช้จ่ายทั้งหมด</p>
                        </div>
                        <div class="hidden md:block">
                            <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i class="fas fa-history text-white text-3xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        <button onclick="showAdminDashboard()" class="px-6 py-3 bg-white/20 hover:bg-white/30 text-white rounded-xl transition-all duration-300 backdrop-blur-sm border border-white/30">
                            <i class="fas fa-arrow-left mr-2"></i> กลับแดชบอร์ด
                        </button>
                        <button onclick="openWithdrawModal()" class="px-6 py-3 bg-white/90 hover:bg-white text-emerald-700 rounded-xl transition-all duration-300 font-medium">
                            <i class="fas fa-plus mr-2"></i> เพิ่มรายการใหม่
                        </button>
                        <div id="treasurerPasswordBtn" class="hidden">
                            <button onclick="openChangePasswordModal()" class="px-6 py-3 bg-white/20 hover:bg-white/30 text-white rounded-xl transition-all duration-300 backdrop-blur-sm border border-white/30">
                                <i class="fas fa-key mr-2"></i> เปลี่ยนรหัสผ่าน
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Decorative Elements -->
                <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/5 rounded-full"></div>
            </div>

            <!-- Summary Cards -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/30">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-arrow-down text-white text-xl"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-600" id="summaryTotalIncome">0</p>
                            <p class="text-sm text-green-500">บาท</p>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">รายรับรวม</h3>
                    <p class="text-sm text-gray-600">เงินที่เก็บได้ทั้งหมด</p>
                </div>
                
                <div class="bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/30">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-arrow-up text-white text-xl"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-red-600" id="summaryTotalExpense">0</p>
                            <p class="text-sm text-red-500">บาท</p>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">รายจ่ายรวม</h3>
                    <p class="text-sm text-gray-600">เงินที่ใช้ไปทั้งหมด</p>
                </div>
                
                <div class="bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl border border-white/30">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-wallet text-white text-xl"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-emerald-600" id="summaryBalance">0</p>
                            <p class="text-sm text-emerald-500">บาท</p>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">คงเหลือ</h3>
                    <p class="text-sm text-gray-600">เงินที่เหลือใช้ได้</p>
                </div>
            </div>

            <!-- Expense History List -->
            <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-list-ul mr-3"></i>
                                รายการทั้งหมด
                            </h3>
                            <p class="text-emerald-100 text-sm mt-1">ประวัติการถอนเงินและค่าใช้จ่าย</p>
                        </div>
                        <div class="text-right">
                            <div class="text-white/90 text-sm font-medium" id="expenseListStatus">กำลังโหลด...</div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="expenseHistoryList">
                        <div class="py-16 px-6 text-center text-gray-500">
                            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-spinner fa-spin text-gray-400 text-3xl"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-700 mb-2">กำลังโหลดข้อมูล</h4>
                            <p class="text-gray-500">กรุณารอสักครู่...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="hidden slide-in">
            <!-- Header Section -->
            <div class="relative overflow-hidden bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 rounded-3xl shadow-2xl mb-8">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative p-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">แดชบอร์ดนักเรียน</h2>
                            <p class="text-purple-100 text-lg">ตรวจสอบข้อมูลและสถานะการจ่ายเงินของคุณ</p>
                        </div>
                        <div class="hidden md:block">
                            <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i class="fas fa-user-graduate text-white text-3xl"></i>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Decorative Elements -->
                <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white/5 rounded-full"></div>
            </div>



            <!-- Class Money Summary Card -->
            <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden mb-8">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-piggy-bank mr-2"></i>
                        สรุปเงินห้อง
                    </h3>
                    <p class="text-emerald-100 text-sm mt-1">ข้อมูลการเงินของห้องทั้งหมด</p>
                </div>
                <div class="p-4">
                    <div id="classMoneySummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 text-center">
                            <p class="text-gray-600">กำลังโหลด...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Student Payment Status -->
                <div class="lg:col-span-2">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6">
                            <h3 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-credit-card mr-3"></i>
                                สถานะการจ่ายเงิน
                            </h3>
                            <p class="text-emerald-100 text-sm mt-1">ตรวจสอบสถานะการชำระเงินปัจจุบัน</p>
                        </div>
                        <div class="p-6">
                            <div id="studentPaymentStatus" class="space-y-4">
                                <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                                    <p class="text-gray-600 text-center">กำลังโหลดข้อมูล...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History -->
                <div class="lg:col-span-1">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/30 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-history mr-3"></i>
                                ประวัติการจ่าย
                            </h3>
                            <p class="text-blue-100 text-sm mt-1">รายการชำระเงินที่ผ่านมา</p>
                        </div>
                        <div class="p-6">
                            <div id="paymentHistory" class="space-y-4 max-h-96 overflow-y-auto">
                                <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                                    <p class="text-gray-600 text-center">กำลังโหลดประวัติ...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw/Expense Modal -->
    <div id="withdrawModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800" id="expenseModalTitle">ถอนเงิน/ใช้จ่าย</h3>
                    <button onclick="closeWithdrawModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form onsubmit="saveExpense(event)" class="space-y-6">
                    <input type="hidden" id="editingExpenseId" value="">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">ประเภทรายการ</label>
                        <select id="expenseType" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" required>
                            <option value="">-- เลือกประเภท --</option>
                            <option value="supplies">อุปกรณ์การเรียน</option>
                            <option value="cleaning">ของใช้ทำความสะอาด</option>
                            <option value="decoration">ตกแต่งห้องเรียน</option>
                            <option value="activity">กิจกรรมห้อง</option>
                            <option value="food">อาหารและเครื่องดื่ม</option>
                            <option value="repair">ซ่อมแซม</option>
                            <option value="other">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">รายละเอียด</label>
                        <input type="text" id="expenseDescription" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="ระบุรายละเอียดการใช้เงิน" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">จำนวนเงิน (บาท)</label>
                        <input type="number" id="expenseAmount" min="1" step="0.01" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">วันที่</label>
                        <input type="date" id="expenseDate" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">หมายเหตุ (ไม่บังคับ)</label>
                        <textarea id="expenseNote" rows="3" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                    </div>
                    <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-emerald-700 font-medium">เงินคงเหลือปัจจุบัน:</span>
                            <span class="text-emerald-800 font-bold text-lg" id="currentBalance">0 บาท</span>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeWithdrawModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                            ยกเลิก
                        </button>
                        <button type="submit" id="saveExpenseBtn" class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl transition-all duration-300 font-medium">
                            <i class="fas fa-save mr-2"></i> บันทึก
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Expense Confirmation Modal -->
    <div id="deleteExpenseConfirmModal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-600 text-3xl mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">ยืนยันการลบรายจ่าย</h3>
                    <p class="text-gray-600">คุณต้องการลบรายการใช้เงินนี้หรือไม่?</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                    <div class="text-center">
                        <h4 class="font-semibold text-red-800 text-lg" id="deleteExpenseDescription">-</h4>
                        <p class="text-red-600 text-sm" id="deleteExpenseAmount">-</p>
                        <p class="text-red-500 text-xs mt-1" id="deleteExpenseDate">-</p>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                    <p class="text-yellow-800 text-sm">
                        <strong><i class="fas fa-warning mr-1"></i> คำเตือน:</strong> การลบรายการจะไม่สามารถกู้คืนได้ และจะส่งผลต่อยอดเงินคงเหลือ
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeDeleteExpenseConfirmModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                        ยกเลิก
                    </button>
                    <button type="button" onclick="confirmDeleteExpense()" id="confirmDeleteExpenseBtn" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-all duration-300 font-medium">
                        <i class="fas fa-trash mr-2"></i> ลบรายการ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Modal -->
    <div id="weekModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800" id="weekModalTitle">เพิ่มสัปดาห์การจ่าย</h3>
                    <button onclick="closeWeekModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form onsubmit="savePaymentWeek(event)" class="space-y-6">
                    <input type="hidden" id="editingWeekId" value="">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">สัปดาห์ที่</label>
                        <input type="number" id="weekNumber" min="1" max="52" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">จำนวนเงิน (บาท)</label>
                        <input type="number" id="paymentAmount" min="1" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeWeekModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                            ยกเลิก
                        </button>
                        <button type="submit" id="setWeekBtn" class="flex-1 py-3 gradient-primary text-white rounded-xl hover:shadow-xl transition-all duration-300 btn-glow font-medium">
                            <i class="fas fa-calendar-plus mr-2"></i> บันทึกสัปดาห์
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Week Confirmation Modal -->
    <div id="deleteWeekConfirmModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-600 text-3xl mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">ยืนยันการลบสัปดาห์</h3>
                    <p class="text-gray-600">คุณต้องการลบสัปดาห์การจ่ายนี้หรือไม่?</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                    <div class="text-center">
                        <h4 class="font-semibold text-red-800 text-lg" id="deleteWeekText">-</h4>
                        <p class="text-red-600 text-sm" id="deleteWeekAmount">-</p>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                    <p class="text-yellow-800 text-sm">
                        <strong><i class="fas fa-warning mr-1"></i> คำเตือน:</strong> การลบสัปดาห์จะลบประวัติการจ่ายเงินของสัปดาห์นี้ทั้งหมด และจะรีเซ็ตสถานะการจ่ายของนักเรียนทุกคน
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeDeleteWeekConfirmModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                        ยกเลิก
                    </button>
                    <button type="button" onclick="confirmDeleteWeek()" id="confirmDeleteWeekBtn" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-all duration-300 font-medium">
                        <i class="fas fa-trash mr-2"></i> ลบสัปดาห์
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">แก้ไขข้อมูลนักเรียน</h3>
                    <button onclick="closeEditStudentModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form onsubmit="updateStudent(event)" class="space-y-6">
                    <input type="hidden" id="editStudentOriginalId" value="">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">เลขที่</label>
                            <input type="text" id="editStudentNumber" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">รหัสนักเรียน</label>
                            <input type="text" id="editStudentId" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">คำนำหน้า</label>
                            <select id="editStudentPrefix" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                                <option value="">เลือก</option>
                                <option value="นาย">นาย</option>
                                <option value="นางสาว">นางสาว</option>
                                <option value="เด็กชาย">เด็กชาย</option>
                                <option value="เด็กหญิง">เด็กหญิง</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">ชื่อ</label>
                            <input type="text" id="editStudentFirstName" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">สกุล</label>
                            <input type="text" id="editStudentLastName" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่าน</label>
                        <input type="text" id="editStudentPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">บทบาท</label>
                        <select id="editStudentRole" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <option value="student">นักเรียนทั่วไป</option>
                            <option value="treasurer">เหรัญญิก (มีสิทธิ์เหมือนครู)</option>
                        </select>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-blue-800 text-sm">
                            <strong><i class="fas fa-info-circle mr-1"></i> หมายเหตุ:</strong> การแก้ไขรหัสนักเรียนจะส่งผลต่อการเข้าสู่ระบบของนักเรียน
                        </p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <p class="text-yellow-800 text-sm">
                            <strong><i class="fas fa-crown mr-1"></i> เหรัญญิก:</strong> นักเรียนที่เป็นเหรัญญิกจะสามารถใช้งานระบบได้เหมือนครู ยกเว้นการจัดการข้อมูลนักเรียน
                        </p>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeEditStudentModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                            ยกเลิก
                        </button>
                        <button type="submit" id="updateStudentBtn" class="flex-1 py-3 gradient-primary text-white rounded-xl hover:shadow-xl transition-all duration-300 btn-glow font-medium">
                            <i class="fas fa-save mr-2"></i> บันทึกการแก้ไข
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Student Management Modal -->
    <div id="studentManagementModal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full modal-enter max-h-[90vh] overflow-hidden">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">จัดการข้อมูลนักเรียน</h3>
                    <button onclick="closeStudentManagementModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-blue-800 text-sm">
                        <strong><i class="fas fa-info-circle mr-1"></i> คำแนะนำ:</strong> เลือกนักเรียนที่ต้องการแก้ไขหรือลบข้อมูล
                    </p>
                </div>

                <div class="max-h-96 overflow-y-auto">
                    <div class="space-y-3" id="studentManagementList">
                        <div class="py-12 px-6 text-center text-gray-500">
                            <div class="text-4xl mb-3"><i class="fas fa-users"></i></div>
                            <p class="text-lg font-medium">กำลังโหลดรายชื่อนักเรียน...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 z-[70] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full modal-enter">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-600 text-3xl mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">ยืนยันการลบ</h3>
                    <p class="text-gray-600">คุณต้องการลบนักเรียนคนนี้ออกจากระบบหรือไม่?</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center font-bold text-sm text-red-700" id="deleteStudentNumber">
                            -
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-800 text-sm" id="deleteStudentName">-</h4>
                            <p class="text-xs text-red-600">รหัส: <span id="deleteStudentId">-</span></p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                    <p class="text-yellow-800 text-sm">
                        <strong><i class="fas fa-warning mr-1"></i> คำเตือน:</strong> การลบนักเรียนจะไม่สามารถกู้คืนได้ และจะลบประวัติการจ่ายเงินทั้งหมดด้วย
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeDeleteConfirmModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                        ยกเลิก
                    </button>
                    <button type="button" onclick="confirmDeleteStudent()" id="confirmDeleteBtn" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-all duration-300 font-medium">
                        <i class="fas fa-trash mr-2"></i> ลบนักเรียน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full modal-enter max-h-[90vh] overflow-y-auto my-8">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">เพิ่มนักเรียน</h3>
                    <button onclick="closeStudentModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="flex space-x-1 mb-6 bg-gray-100 rounded-xl p-1">
                    <button onclick="switchTab('single')" id="singleTab" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-white text-purple-600 shadow-sm">
                        <i class="fas fa-user mr-2"></i>เพิ่มคนเดียว
                    </button>
                    <button onclick="switchTab('bulk')" id="bulkTab" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600">
                        <i class="fas fa-users mr-2"></i>นำเข้าจาก Excel
                    </button>
                </div>

                <!-- Single Student Form -->
                <div id="singleStudentForm" class="space-y-6">
                    <form onsubmit="addSingleStudent(event)" class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-3">เลขที่</label>
                                <input type="text" id="studentNumber" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-3">รหัสนักเรียน</label>
                                <input type="text" id="studentId" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-3">คำนำหน้า</label>
                                <select id="studentPrefix" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                                    <option value="">เลือก</option>
                                    <option value="นาย">นาย</option>
                                    <option value="นางสาว">นางสาว</option>
                                    <option value="เด็กชาย">เด็กชาย</option>
                                    <option value="เด็กหญิง">เด็กหญิง</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-3">ชื่อ</label>
                                <input type="text" id="studentFirstName" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-3">สกุล</label>
                                <input type="text" id="studentLastName" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่านเริ่มต้น</label>
                            <input type="text" id="studentPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="123456" value="123456" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-3">บทบาท</label>
                            <select id="studentRole" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <option value="student">นักเรียนทั่วไป</option>
                                <option value="treasurer">เหรัญญิก (มีสิทธิ์เหมือนครู)</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-blue-800 text-sm">
                                <strong><i class="fas fa-info-circle mr-1"></i> หมายเหตุ:</strong> นักเรียนจะใช้รหัสนักเรียนและรหัสผ่านนี้เข้าสู่ระบบ
                            </p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                            <p class="text-yellow-800 text-sm">
                                <strong><i class="fas fa-crown mr-1"></i> เหรัญญิก:</strong> นักเรียนที่เป็นเหรัญญิกจะสามารถใช้งานระบบได้เหมือนครู ยกเว้นการจัดการข้อมูลนักเรียน
                            </p>
                        </div>
                        <div class="flex space-x-4">
                            <button type="button" onclick="closeStudentModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                                ยกเลิก
                            </button>
                            <button type="submit" id="addStudentBtn" class="flex-1 py-3 gradient-secondary text-white rounded-xl hover:shadow-xl transition-all duration-300 font-medium">
                                <i class="fas fa-user-plus mr-2"></i> เพิ่มนักเรียน
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Bulk Import Form -->
                <div id="bulkImportForm" class="hidden space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-6">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-file-excel text-green-600 mr-2"></i>วิธีการนำเข้าจาก Excel
                        </h4>
                        <div class="space-y-2 text-sm text-gray-700">
                            <p><strong>รูปแบบข้อมูล:</strong> เลขที่[Tab]รหัสนักเรียน[Tab]คำนำหน้า[Tab]ชื่อ[Tab]สกุล</p>
                            <p><strong>ตัวอย่าง:</strong></p>
                            <div class="bg-white rounded-lg p-3 font-mono text-xs border">
                                1&nbsp;&nbsp;&nbsp;&nbsp;65001&nbsp;&nbsp;&nbsp;&nbsp;นาย&nbsp;&nbsp;&nbsp;&nbsp;สมชาย&nbsp;&nbsp;&nbsp;&nbsp;ใจดี<br>
                                2&nbsp;&nbsp;&nbsp;&nbsp;65002&nbsp;&nbsp;&nbsp;&nbsp;นางสาว&nbsp;&nbsp;&nbsp;&nbsp;สมหญิง&nbsp;&nbsp;&nbsp;&nbsp;รักเรียน<br>
                                3&nbsp;&nbsp;&nbsp;&nbsp;65003&nbsp;&nbsp;&nbsp;&nbsp;เด็กชาย&nbsp;&nbsp;&nbsp;&nbsp;สมศักดิ์&nbsp;&nbsp;&nbsp;&nbsp;เก่งมาก
                            </div>
                            <div class="flex items-start space-x-2 mt-3">
                                <i class="fas fa-lightbulb text-yellow-500 mt-0.5"></i>
                                <div class="text-xs">
                                    <p><strong>วิธีใช้:</strong> เลือกข้อมูลใน Excel ทั้ง 5 คอลัมน์ → คัดลอก (Ctrl+C) → วางในช่องด้านล่าง (Ctrl+V)</p>
                                    <p class="text-gray-600 mt-1">• คำนำหน้าที่รองรับ: นาย, นางสาว, เด็กชาย, เด็กหญิง</p>
                                    <p class="text-gray-600">• สามารถเว้นว่างไว้และเพิ่มนักเรียนทีหลังได้</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">วางข้อมูลจาก Excel</label>
                        <textarea id="bulkStudentData" rows="8" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-mono text-sm" placeholder="วางข้อมูลที่คัดลอกจาก Excel ที่นี่...&#10;&#10;ตัวอย่าง:&#10;1	65001	นาย	สมชาย	ใจดี&#10;2	65002	นางสาว	สมหญิง	รักเรียน&#10;3	65003	เด็กชาย	สมศักดิ์	เก่งมาก"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-3">รหัสผ่านเริ่มต้นสำหรับทุกคน</label>
                        <input type="text" id="bulkPassword" class="w-full px-4 py-3 bg-white/50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" value="123456" required>
                    </div>
                    
                    <div id="previewSection" class="hidden">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-eye text-blue-600 mr-2"></i>ตัวอย่างข้อมูลที่จะเพิ่ม
                        </h4>
                        <div id="previewData" class="bg-gray-50 rounded-xl p-4 max-h-40 overflow-y-auto"></div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeStudentModal()" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition-all duration-300 font-medium">
                            ยกเลิก
                        </button>
                        <button type="button" onclick="previewBulkData()" id="previewBulkBtn" class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-all duration-300 font-medium">
                            <i class="fas fa-eye mr-2"></i> ดูตัวอย่าง
                        </button>
                        <button type="button" onclick="importBulkStudents()" id="importBulkBtn" class="flex-1 py-3 gradient-secondary text-white rounded-xl hover:shadow-xl transition-all duration-300 font-medium">
                            <i class="fas fa-upload mr-2"></i> นำเข้าข้อมูล
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
            <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">กำลังประมวลผล...</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden fixed top-6 right-6 z-50 max-w-sm">
        <div id="notificationCard" class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-5 transform transition-all duration-300 ease-out">
            <div class="flex items-start space-x-4">
                <div id="notificationIcon" class="flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-check text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 id="notificationTitle" class="text-base font-bold text-gray-900 mb-1"></h4>
                    <p id="notificationMessage" class="text-sm text-gray-600 leading-relaxed"></p>
                </div>
                <button onclick="hideNotification()" class="flex-shrink-0 w-8 h-8 rounded-xl bg-gray-100/80 hover:bg-gray-200/80 text-gray-500 hover:text-gray-700 transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
            <div id="notificationProgress" class="mt-4 h-1.5 bg-gray-100/60 rounded-full overflow-hidden">
                <div id="notificationProgressBar" class="h-full transition-all duration-75 ease-linear rounded-full"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase services (initialized in module script above)
        let app, auth, db;
        let isFirebaseConnected = false;

        // Wait for Firebase to be initialized
        async function initializeFirebase() {
            try {
                // Wait for Firebase modules to be available
                let attempts = 0;
                while ((!window.firebaseApp || !window.firebaseAuth || !window.firebaseDb) && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (window.firebaseApp && window.firebaseAuth && window.firebaseDb) {
                    app = window.firebaseApp;
                    auth = window.firebaseAuth;
                    db = window.firebaseDb;
                    
                    // Test Firebase connection
                    await testFirebaseConnection();
                    
                    isFirebaseConnected = true;
                    console.log('Firebase Realtime Database v12 connected successfully!');
                    updateConnectionStatus(true);
                    return true;
                } else {
                    throw new Error('Firebase services not available after waiting');
                }
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                isFirebaseConnected = false;
                updateConnectionStatus(false);
                return false;
            }
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                // Try to access Realtime Database
                const testRef = window.ref(db, 'test/connection');
                await window.get(testRef);
                console.log('Firebase Realtime Database connection test successful');
            } catch (error) {
                console.log('Firebase connection test failed, but continuing:', error.message);
                // Don't throw error here, just log it
            }
        }

        // Global variables
        let students = [];
        let currentUser = null;
        let selectedWeekId = null;
        let currentWeek = null;
        let allWeeks = [];
        let weekToDelete = null;
        let allExpenses = [];
        let totalIncome = 0;
        let totalExpense = 0;
        let remainingBalance = 0;
        let expenseToDelete = null;

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const firebaseStatusEl = document.getElementById('firebaseStatusText');
            
            if (connected) {
                statusEl.className = 'w-3 h-3 bg-green-500 rounded-full pulse';
                statusEl.title = 'เชื่อมต่อ Firebase สำเร็จ';
                if (firebaseStatusEl) {
                    firebaseStatusEl.textContent = 'เชื่อมต่อ Firebase สำเร็จ - พร้อมใช้งาน';
                    firebaseStatusEl.parentElement.parentElement.className = 'bg-green-50 border border-green-200 rounded-xl p-4';
                    firebaseStatusEl.parentElement.className = 'text-green-800 text-sm';
                }
            } else {
                statusEl.className = 'w-3 h-3 bg-red-500 rounded-full pulse';
                statusEl.title = 'ไม่สามารถเชื่อมต่อ Firebase ได้';
                if (firebaseStatusEl) {
                    firebaseStatusEl.textContent = 'ไม่สามารถเชื่อมต่อ Firebase ได้ - กรุณาตรวจสอบการตั้งค่า';
                    firebaseStatusEl.parentElement.parentElement.className = 'bg-red-50 border border-red-200 rounded-xl p-4';
                    firebaseStatusEl.parentElement.className = 'text-red-800 text-sm';
                }
            }
        }

        // Firebase Authentication Functions
        async function createUserAccount(email, password, userData) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า');
            }

            try {
                const userCredential = await window.createUserWithEmailAndPassword(auth, email, password);
                const userRef = window.ref(db, `users/${userCredential.user.uid}`);
                await window.set(userRef, {
                    ...userData,
                    createdAt: window.serverTimestamp()
                });
                return userCredential;
            } catch (error) {
                throw error;
            }
        }

        async function signInUser(email, password) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า');
            }

            try {
                return await window.signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                throw error;
            }
        }

        async function signInStudent(studentId, password) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า');
            }

            try {
                const studentRef = window.ref(db, `students/${studentId}`);
                const snapshot = await window.get(studentRef);
                if (snapshot.exists() && snapshot.val().password === password) {
                    return { user: { uid: studentId, isStudent: true } };
                }
                throw new Error('รหัสนักเรียนหรือรหัสผ่านไม่ถูกต้อง');
            } catch (error) {
                throw error;
            }
        }

        // Realtime Database Data Functions
        async function loadStudents() {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            try {
                // For student/treasurer, find their teacher and load students from that teacher
                if (currentUser && (currentUser.role === 'student' || currentUser.role === 'treasurer')) {
                    const studentData = await getStudentData(currentUser.studentId);
                    if (studentData && studentData.teacherId) {
                        const studentsRef = window.ref(db, `teachers/${studentData.teacherId}/students`);
                        const snapshot = await window.get(studentsRef);
                        
                        if (snapshot.exists()) {
                            const studentsData = snapshot.val();
                            students = Object.keys(studentsData).map(key => ({
                                id: key,
                                ...studentsData[key]
                            })).sort((a, b) => parseInt(a.number) - parseInt(b.number));
                        } else {
                            students = [];
                        }
                        return;
                    }
                }

                // For teacher, load their own students
                if (!currentUser || !currentUser.uid) {
                    throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
                }

                // Load students for current teacher only
                const studentsRef = window.ref(db, `teachers/${currentUser.uid}/students`);
                const snapshot = await window.get(studentsRef);
                
                if (snapshot.exists()) {
                    const studentsData = snapshot.val();
                    students = Object.keys(studentsData).map(key => ({
                        id: key,
                        ...studentsData[key]
                    })).sort((a, b) => parseInt(a.number) - parseInt(b.number));
                } else {
                    students = [];
                }
            } catch (error) {
                console.error('Error loading students:', error);
                throw new Error('เกิดข้อผิดพลาดในการโหลดข้อมูลนักเรียน: ' + error.message);
            }
        }

        async function addStudent(studentData) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                // Add student under current teacher's data
                const studentRef = window.ref(db, `teachers/${currentUser.uid}/students/${studentData.studentId}`);
                await window.set(studentRef, {
                    ...studentData,
                    teacherId: currentUser.uid,
                    createdAt: window.serverTimestamp()
                });
            } catch (error) {
                throw error;
            }
        }

        async function updateStudentPayment(studentId, paid, weekId = null, paidAmount = null) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                const updateData = {
                    paid: paid,
                    lastUpdated: window.serverTimestamp()
                };

                if (weekId) {
                    updateData.weekId = weekId;
                }

                if (paid && paidAmount !== null) {
                    updateData.paidAmount = paidAmount;
                } else if (!paid) {
                    updateData.paidAmount = null;
                }

                // Update student under current teacher's data
                const studentRef = window.ref(db, `teachers/${currentUser.uid}/students/${studentId}`);
                await window.update(studentRef, updateData);

                // Also record payment history under current teacher
                if (paid && currentWeek) {
                    const paymentsRef = window.ref(db, `teachers/${currentUser.uid}/payments`);
                    const newPaymentRef = window.push(paymentsRef);
                    await window.set(newPaymentRef, {
                        studentId: studentId,
                        weekId: weekId || currentWeek.id,
                        week: currentWeek.week,
                        amount: paidAmount || currentWeek.amount,
                        standardAmount: currentWeek.amount,
                        teacherId: currentUser.uid,
                        paidAt: window.serverTimestamp()
                    });
                }
            } catch (error) {
                throw error;
            }
        }

        async function addPaymentWeek(weekData) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                // Add week under current teacher's data
                const weeksRef = window.ref(db, `teachers/${currentUser.uid}/weeks`);
                const newWeekRef = window.push(weeksRef);
                await window.set(newWeekRef, {
                    ...weekData,
                    teacherId: currentUser.uid,
                    createdAt: window.serverTimestamp()
                });
                
                // Set as current week
                currentWeek = {
                    id: newWeekRef.key,
                    ...weekData
                };
                
                return newWeekRef;
            } catch (error) {
                throw error;
            }
        }

        async function loadAllWeeks() {
            if (!isFirebaseConnected) {
                return [];
            }

            try {
                let teacherId = null;

                // For student/treasurer, find their teacher ID
                if (currentUser && (currentUser.role === 'student' || currentUser.role === 'treasurer')) {
                    const studentData = await getStudentData(currentUser.studentId);
                    if (studentData && studentData.teacherId) {
                        teacherId = studentData.teacherId;
                    }
                } else if (currentUser && currentUser.uid) {
                    // For teacher, use their own ID
                    teacherId = currentUser.uid;
                }

                if (!teacherId) {
                    allWeeks = [];
                    return [];
                }

                // Load weeks for the determined teacher
                const weeksRef = window.ref(db, `teachers/${teacherId}/weeks`);
                const snapshot = await window.get(weeksRef);
                
                if (snapshot.exists()) {
                    const weeksData = snapshot.val();
                    allWeeks = Object.keys(weeksData).map(key => ({
                        id: key,
                        ...weeksData[key]
                    })).sort((a, b) => {
                        // Sort by week number
                        return a.week - b.week;
                    });
                    
                    return allWeeks;
                }
                allWeeks = [];
                return [];
            } catch (error) {
                console.error('Error loading weeks:', error);
                allWeeks = [];
                return [];
            }
        }

        async function loadCurrentWeek() {
            await loadAllWeeks();
            
            if (allWeeks && allWeeks.length > 0) {
                // Get the most recent week (last created)
                const sortedByCreated = [...allWeeks].sort((a, b) => {
                    const aTime = a.createdAt || 0;
                    const bTime = b.createdAt || 0;
                    return bTime - aTime;
                });
                currentWeek = sortedByCreated[0];
                return currentWeek;
            }
            
            // No weeks exist
            currentWeek = null;
            return null;
        }

        async function getUserData(uid) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            try {
                const userRef = window.ref(db, `users/${uid}`);
                const snapshot = await window.get(userRef);
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                console.error('Error getting user data:', error);
                throw error;
            }
        }

        async function getStudentData(studentId) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            try {
                // For student login, search across all teachers
                if (!currentUser || currentUser.role === 'student' || currentUser.role === 'treasurer') {
                    const teachersRef = window.ref(db, 'teachers');
                    const teachersSnapshot = await window.get(teachersRef);
                    
                    if (teachersSnapshot.exists()) {
                        const teachersData = teachersSnapshot.val();
                        
                        // Search for student across all teachers
                        for (const teacherId of Object.keys(teachersData)) {
                            if (teachersData[teacherId].students && teachersData[teacherId].students[studentId]) {
                                const studentData = teachersData[teacherId].students[studentId];
                                // Store teacher ID for later use
                                studentData.teacherId = teacherId;
                                return studentData;
                            }
                        }
                    }
                    return null;
                }

                // For teacher accessing student data (existing logic)
                if (!currentUser.uid) {
                    throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
                }

                // Get student data from current teacher's data
                const studentRef = window.ref(db, `teachers/${currentUser.uid}/students/${studentId}`);
                const snapshot = await window.get(studentRef);
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                console.error('Error getting student data:', error);
                throw error;
            }
        }

        async function getPaymentHistory(studentId) {
            if (!isFirebaseConnected) {
                return [];
            }

            try {
                let teacherId = null;

                // For student/treasurer, find their teacher ID
                if (currentUser && (currentUser.role === 'student' || currentUser.role === 'treasurer')) {
                    const studentData = await getStudentData(studentId);
                    if (studentData && studentData.teacherId) {
                        teacherId = studentData.teacherId;
                    }
                } else if (currentUser && currentUser.uid) {
                    // For teacher, use their own ID
                    teacherId = currentUser.uid;
                }

                if (!teacherId) {
                    return [];
                }

                // Get payment history from the determined teacher's data
                const paymentsRef = window.ref(db, `teachers/${teacherId}/payments`);
                const snapshot = await window.get(paymentsRef);
                
                if (snapshot.exists()) {
                    const paymentsData = snapshot.val();
                    const studentPayments = Object.keys(paymentsData)
                        .filter(key => paymentsData[key].studentId === studentId)
                        .map(key => ({
                            id: key,
                            ...paymentsData[key]
                        }))
                        .sort((a, b) => {
                            const aTime = a.paidAt || 0;
                            const bTime = b.paidAt || 0;
                            return bTime - aTime; // Sort by most recent first
                        });
                    
                    return studentPayments;
                }
                return [];
            } catch (error) {
                console.error('Error getting payment history:', error);
                return [];
            }
        }

        async function addExpense(expenseData) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                // Add expense under current teacher's data
                const expensesRef = window.ref(db, `teachers/${currentUser.uid}/expenses`);
                const newExpenseRef = window.push(expensesRef);
                await window.set(newExpenseRef, {
                    ...expenseData,
                    teacherId: currentUser.uid,
                    createdAt: window.serverTimestamp()
                });
                return newExpenseRef;
            } catch (error) {
                throw error;
            }
        }

        async function updateExpense(expenseId, expenseData) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                // Update expense under current teacher's data
                const expenseRef = window.ref(db, `teachers/${currentUser.uid}/expenses/${expenseId}`);
                await window.update(expenseRef, {
                    ...expenseData,
                    lastUpdated: window.serverTimestamp()
                });
            } catch (error) {
                throw error;
            }
        }

        async function deleteExpenseFromDB(expenseId) {
            if (!isFirebaseConnected) {
                throw new Error('ไม่สามารถเชื่อมต่อ Firebase ได้');
            }

            if (!currentUser || !currentUser.uid) {
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
            }

            try {
                // Delete expense from current teacher's data
                const expenseRef = window.ref(db, `teachers/${currentUser.uid}/expenses/${expenseId}`);
                await window.set(expenseRef, null);
            } catch (error) {
                throw error;
            }
        }

        async function loadAllExpenses() {
            if (!isFirebaseConnected) {
                return [];
            }

            try {
                let teacherId = null;

                // For student/treasurer, find their teacher ID
                if (currentUser && (currentUser.role === 'student' || currentUser.role === 'treasurer')) {
                    const studentData = await getStudentData(currentUser.studentId);
                    if (studentData && studentData.teacherId) {
                        teacherId = studentData.teacherId;
                    }
                } else if (currentUser && currentUser.uid) {
                    // For teacher, use their own ID
                    teacherId = currentUser.uid;
                }

                if (!teacherId) {
                    allExpenses = [];
                    return [];
                }

                // Load expenses for the determined teacher
                const expensesRef = window.ref(db, `teachers/${teacherId}/expenses`);
                const snapshot = await window.get(expensesRef);
                
                if (snapshot.exists()) {
                    const expensesData = snapshot.val();
                    allExpenses = Object.keys(expensesData).map(key => ({
                        id: key,
                        ...expensesData[key]
                    })).sort((a, b) => {
                        // Sort by date (most recent first)
                        const aDate = new Date(a.date);
                        const bDate = new Date(b.date);
                        return bDate - aDate;
                    });
                    
                    return allExpenses;
                }
                allExpenses = [];
                return [];
            } catch (error) {
                console.error('Error loading expenses:', error);
                allExpenses = [];
                return [];
            }
        }

        async function calculateFinancials() {
            try {
                let teacherId = null;

                // For student/treasurer, find their teacher ID
                if (currentUser && (currentUser.role === 'student' || currentUser.role === 'treasurer')) {
                    const studentData = await getStudentData(currentUser.studentId);
                    if (studentData && studentData.teacherId) {
                        teacherId = studentData.teacherId;
                    }
                } else if (currentUser && currentUser.uid) {
                    // For teacher, use their own ID
                    teacherId = currentUser.uid;
                }

                if (!teacherId) {
                    return {
                        totalIncome: 0,
                        totalExpense: 0,
                        remainingBalance: 0
                    };
                }

                // Calculate total income from payments for the determined teacher
                const paymentsRef = window.ref(db, `teachers/${teacherId}/payments`);
                const paymentsSnapshot = await window.get(paymentsRef);
                
                totalIncome = 0;
                if (paymentsSnapshot.exists()) {
                    const paymentsData = paymentsSnapshot.val();
                    Object.values(paymentsData).forEach(payment => {
                        totalIncome += payment.amount || 0;
                    });
                }

                // Calculate total expenses for the determined teacher
                await loadAllExpenses();
                totalExpense = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                
                // Calculate remaining balance
                remainingBalance = totalIncome - totalExpense;
                
                return {
                    totalIncome,
                    totalExpense,
                    remainingBalance
                };
            } catch (error) {
                console.error('Error calculating financials:', error);
                return {
                    totalIncome: 0,
                    totalExpense: 0,
                    remainingBalance: 0
                };
            }
        }

        // Navigation Functions
        function showWelcome() {
            hideAllScreens();
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function showLogin() {
            hideAllScreens();
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showRegister() {
            hideAllScreens();
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function hideAllScreens() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('expenseHistoryDashboard').classList.add('hidden');
        }

        // Login Tab Management
        function switchLoginTab(tabName) {
            const teacherTab = document.getElementById('teacherLoginTab');
            const studentTab = document.getElementById('studentLoginTab');
            const teacherForm = document.getElementById('teacherLoginForm');
            const studentForm = document.getElementById('studentLoginForm');
            
            if (tabName === 'teacher') {
                teacherTab.className = 'flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all bg-white text-purple-600 shadow-sm';
                studentTab.className = 'flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600';
                teacherForm.classList.remove('hidden');
                studentForm.classList.add('hidden');
            } else {
                studentTab.className = 'flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all bg-white text-green-600 shadow-sm';
                teacherTab.className = 'flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600';
                studentForm.classList.remove('hidden');
                teacherForm.classList.add('hidden');
            }
        }

        // Authentication Functions
        async function handleTeacherLogin(event) {
            event.preventDefault();
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;
            const loginBtn = document.getElementById('teacherLoginBtn');
            
            try {
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังเข้าสู่ระบบ...';
                loginBtn.disabled = true;
                showLoading();
                
                // Teacher login
                const result = await signInUser(email, password);
                const userData = await getUserData(result.user.uid);
                
                if (userData) {
                    currentUser = {
                        uid: result.user.uid,
                        email: email,
                        name: userData.name,
                        role: userData.role
                    };
                    updateNavigation();
                    showAdminDashboard();
                    showNotification('เข้าสู่ระบบครูสำเร็จ! 🎉', 'success');
                    return;
                }
                
                throw new Error('ไม่พบข้อมูลผู้ใช้งาน');
                
            } catch (error) {
                console.error('Teacher login error:', error);
                let errorMessage = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ไม่พบอีเมลนี้ในระบบ';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'รหัสผ่านไม่ถูกต้อง';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-chalkboard-teacher mr-2"></i> เข้าสู่ระบบครู';
                loginBtn.disabled = false;
                hideLoading();
            }
        }

        async function handleStudentLogin(event) {
            event.preventDefault();
            const studentId = document.getElementById('studentId').value;
            const password = document.getElementById('studentPassword').value || '123456'; // Default password
            const loginBtn = document.getElementById('studentLoginBtn');
            
            try {
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังเข้าสู่ระบบ...';
                loginBtn.disabled = true;
                showLoading();
                
                // Student login - no password required for new system
                const studentData = await getStudentData(studentId);
                
                if (studentData) {
                    const userRole = studentData.role === 'treasurer' ? 'treasurer' : 'student';
                    currentUser = {
                        uid: studentId,
                        studentId: studentId,
                        name: studentData.name,
                        role: userRole
                    };
                    updateNavigation();
                    
                    // เหรัญญิกเข้าสู่แดชบอร์ดผู้ดูแล นักเรียนทั่วไปเข้าสู่แดชบอร์ดนักเรียน
                    if (userRole === 'treasurer') {
                        showAdminDashboard();
                        showNotification('เข้าสู่ระบบเหรัญญิกสำเร็จ! 🎉', 'success');
                    } else {
                        showStudentDashboard();
                        showNotification('เข้าสู่ระบบนักเรียนสำเร็จ! 🎉', 'success');
                    }
                    return;
                }
                
                throw new Error('ไม่พบรหัสนักเรียนนี้ในระบบ กรุณาติดต่อครูผู้สอน');
                
            } catch (error) {
                console.error('Student login error:', error);
                let errorMessage = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ';
                
                if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-user-graduate mr-2"></i> เข้าสู่ระบบนักเรียน';
                loginBtn.disabled = false;
                hideLoading();
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            
            try {
                registerBtn.textContent = 'กำลังสมัครสมาชิก...';
                registerBtn.disabled = true;
                showLoading();
                
                if (password.length < 6) {
                    throw new Error('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                }
                
                const userData = {
                    name: name,
                    role: 'teacher',
                    email: email
                };
                
                await createUserAccount(email, password, userData);
                
                showNotification('สมัครสมาชิกครูสำเร็จ! 🎉 กรุณาเข้าสู่ระบบ', 'success');
                showLogin();
                
                // Clear form
                document.getElementById('registerName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'เกิดข้อผิดพลาดในการสมัครสมาชิก';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'อีเมลนี้ถูกใช้งานแล้ว';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'รหัสผ่านไม่ปลอดภัย กรุณาใช้รหัสผ่านที่แข็งแกร่งกว่านี้';
                } else if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                    errorMessage = 'ไม่มีสิทธิ์เข้าถึงฐานข้อมูล กรุณาตรวจสอบการตั้งค่า Firebase Security Rules';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                registerBtn.textContent = 'สมัครสมาชิกครู';
                registerBtn.disabled = false;
                hideLoading();
            }
        }

        async function logout() {
            try {
                // Check if user is authenticated with Firebase
                if (auth && auth.currentUser) {
                    await window.signOut(auth);
                }
                
                // Clear current user data
                currentUser = null;
                selectedWeekId = null;
                currentWeek = null;
                students = [];
                allWeeks = [];
                allExpenses = [];
                
                // Update navigation
                updateNavigation();
                
                // Show welcome screen
                showWelcome();
                
                showNotification('ออกจากระบบสำเร็จ! 👋', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                
                // Force logout even if Firebase signOut fails
                currentUser = null;
                selectedWeekId = null;
                currentWeek = null;
                students = [];
                allWeeks = [];
                allExpenses = [];
                
                updateNavigation();
                showWelcome();
                
                showNotification('ออกจากระบบสำเร็จ! 👋', 'success');
            }
        }

        function updateNavigation() {
            if (currentUser) {
                document.getElementById('navButtons').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('welcomeText').textContent = currentUser.name || 'ผู้ใช้งาน';
                
                let roleText = 'ผู้ใช้งาน';
                if (currentUser.role === 'teacher') roleText = 'ครู';
                else if (currentUser.role === 'treasurer') roleText = 'เหรัญญิก';
                else if (currentUser.role === 'student') roleText = 'นักเรียน';
                
                document.getElementById('userRole').textContent = roleText;
            } else {
                document.getElementById('navButtons').classList.remove('hidden');
                document.getElementById('userMenu').classList.add('hidden');
            }
        }

        // Dashboard Functions
        async function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // ซ่อนการจัดการนักเรียนสำหรับเหรัญญิก
            const studentManagementCard = document.getElementById('studentManagementCard');
            const treasurerPasswordBtnAdmin = document.getElementById('treasurerPasswordBtnAdmin');
            
            if (currentUser && currentUser.role === 'treasurer') {
                studentManagementCard.classList.add('hidden');
                treasurerPasswordBtnAdmin.classList.remove('hidden');
            } else {
                studentManagementCard.classList.remove('hidden');
                treasurerPasswordBtnAdmin.classList.add('hidden');
            }
            
            if (!isFirebaseConnected) {
                showNotification('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า', 'error');
                return;
            }

            try {
                showLoading();
                
                // Reset variables first
                selectedWeekId = null;
                currentWeek = null;
                
                // Load data
                await loadCurrentWeek();
                await loadStudents();
                
                // Update UI
                updateWeekSelector();
                updateAdminStats();
                
                // Show appropriate content based on whether weeks exist
                if (!allWeeks || allWeeks.length === 0) {
                    showNoWeekSelected();
                } else {
                    updateStudentsTable();
                }
                
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function showStudentDashboard() {
            hideAllScreens();
            document.getElementById('studentDashboard').classList.remove('hidden');
            

            
            if (!isFirebaseConnected) {
                showNotification('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า', 'error');
                return;
            }

            try {
                showLoading();
                await loadCurrentWeek();
                await updateStudentPaymentStatus();
            } catch (error) {
                console.error('Error loading student dashboard:', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateAdminStats() {
            const total = students.length;
            let paid = 0;
            let totalAmount = 0;
            
            if (selectedWeekId && currentWeek) {
                // Count students who paid for the selected week and calculate actual total
                const paidStudents = students.filter(s => s.weekId === selectedWeekId && s.paid);
                paid = paidStudents.length;
                
                // Calculate total amount based on actual paid amounts
                totalAmount = paidStudents.reduce((sum, student) => {
                    return sum + (student.paidAmount || currentWeek.amount);
                }, 0);
            }
            
            const unpaid = total - paid;
            
            // Calculate financial data
            await calculateFinancials();
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('paidStudents').textContent = paid;
            document.getElementById('unpaidStudents').textContent = unpaid;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
            document.getElementById('balanceAmount').textContent = remainingBalance.toLocaleString();
            
            // Update money management card
            document.getElementById('remainingBalance').textContent = remainingBalance.toLocaleString();
            document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
            document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
        }

        function updateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            selector.innerHTML = '<option value="">-- เลือกสัปดาห์การจ่าย --</option>';
            
            // Only add weeks if they actually exist
            if (allWeeks && allWeeks.length > 0) {
                allWeeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.id;
                    option.textContent = `สัปดาห์ที่ ${week.week} - ${week.amount} บาท`;
                    selector.appendChild(option);
                });
                
                // Auto-select current week if exists
                if (currentWeek) {
                    selector.value = currentWeek.id;
                    selectedWeekId = currentWeek.id;
                    updateSelectedWeekInfo();
                } else {
                    // Reset selection if no current week
                    selectedWeekId = null;
                    hideSelectedWeekInfo();
                    showNoWeekSelected();
                }
            } else {
                // No weeks exist - reset everything
                selectedWeekId = null;
                currentWeek = null;
                hideSelectedWeekInfo();
                showNoWeekSelected();
            }
        }

        function selectWeek() {
            const selector = document.getElementById('weekSelector');
            selectedWeekId = selector.value;
            
            if (selectedWeekId) {
                currentWeek = allWeeks.find(w => w.id === selectedWeekId);
                updateSelectedWeekInfo();
                loadStudentsForWeek();
            } else {
                currentWeek = null;
                hideSelectedWeekInfo();
                showNoWeekSelected();
            }
        }

        function updateSelectedWeekInfo() {
            if (!currentWeek || !selectedWeekId) {
                hideSelectedWeekInfo();
                return;
            }
            
            document.getElementById('selectedWeekText').textContent = `สัปดาห์ที่ ${currentWeek.week}`;
            document.getElementById('selectedWeekAmount').textContent = `จำนวน ${currentWeek.amount} บาท`;
            document.getElementById('selectedWeekInfo').classList.remove('hidden');
        }

        function hideSelectedWeekInfo() {
            document.getElementById('selectedWeekInfo').classList.add('hidden');
        }

        function showNoWeekSelected() {
            const container = document.getElementById('studentsTable');
            const statusEl = document.getElementById('studentsListStatus');
            
            statusEl.textContent = 'เลือกสัปดาห์การจ่ายก่อน';
            container.innerHTML = `
                <div class="py-12 px-6 text-center text-gray-500" id="noWeekSelected">
                    <div class="text-4xl mb-3"><i class="fas fa-calendar-times"></i></div>
                    <p class="text-lg font-medium">กรุณาเลือกสัปดาห์การจ่ายก่อน</p>
                    <p class="text-sm mt-1">เลือกสัปดาห์จากด้านบนเพื่อดูรายชื่อนักเรียน</p>
                </div>
            `;
        }

        async function loadStudentsForWeek() {
            if (!selectedWeekId || !currentWeek) {
                showNoWeekSelected();
                return;
            }

            try {
                await loadStudents();
                updateStudentsTable();
                updateAdminStats();
            } catch (error) {
                console.error('Error loading students for week:', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลนักเรียน', 'error');
            }
        }

        function updateStudentsTable() {
            if (!selectedWeekId || !currentWeek) {
                showNoWeekSelected();
                return;
            }

            const container = document.getElementById('studentsTable');
            const statusEl = document.getElementById('studentsListStatus');
            
            statusEl.textContent = `สัปดาห์ที่ ${currentWeek.week} - ${currentWeek.amount} บาท`;
            container.innerHTML = '';
            
            if (students.length === 0) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'py-12 px-6 text-center text-gray-500 bg-white/50 rounded-2xl border border-gray-200';
                emptyCard.innerHTML = `
                    <div class="text-4xl mb-3"><i class="fas fa-users"></i></div>
                    <p class="text-lg font-medium">ยังไม่มีนักเรียนในระบบ</p>
                    <p class="text-sm mt-1">เพิ่มนักเรียนคนแรกเพื่อเริ่มต้นใช้งาน</p>
                `;
                container.appendChild(emptyCard);
                return;
            }
            
            students.forEach(student => {
                // Check if student paid for this specific week
                const paidForThisWeek = student.weekId === selectedWeekId && student.paid;
                
                const card = document.createElement('div');
                card.className = `bg-white/70 backdrop-blur-sm rounded-2xl p-4 border border-gray-200 hover:shadow-lg transition-all ${paidForThisWeek ? 'border-green-300 bg-green-50/50' : 'border-red-300 bg-red-50/50'}`;
                
                card.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 ${paidForThisWeek ? 'bg-green-100' : 'bg-red-100'} rounded-xl flex items-center justify-center font-bold text-sm ${paidForThisWeek ? 'text-green-700' : 'text-red-700'}">
                                    ${student.number}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${student.name}</h4>
                                    <p class="text-xs text-gray-500">รหัส: ${student.studentId}</p>
                                </div>
                            </div>
                            <span class="px-4 py-2 rounded-full text-sm font-medium ${paidForThisWeek ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${paidForThisWeek ? '<i class="fas fa-check-circle mr-2"></i> จ่ายแล้ว' : '<i class="fas fa-clock mr-2"></i> ยังไม่จ่าย'}
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-600 mb-1">จำนวนเงินที่จ่าย (บาท)</label>
                                <input 
                                    type="number" 
                                    id="amount_${student.id}" 
                                    min="0" 
                                    step="0.01" 
                                    value="${paidForThisWeek ? (student.paidAmount || currentWeek.amount) : currentWeek.amount}" 
                                    class="w-full px-3 py-2 ${paidForThisWeek ? 'bg-gray-100 cursor-not-allowed' : 'bg-white/70'} border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm"
                                    placeholder="${currentWeek.amount}"
                                    ${paidForThisWeek ? 'disabled readonly' : ''}
                                    onchange="validatePaymentAmount('${student.id}')"
                                >
                                <p class="text-xs text-gray-500 mt-1">กำหนด: ${currentWeek.amount} บาท</p>
                            </div>
                            <button 
                                id="payBtn_${student.id}" 
                                onclick="togglePayment('${student.id}')" 
                                class="px-6 py-3 ${paidForThisWeek ? 'bg-red-500 hover:bg-red-600 focus:ring-red-300' : 'bg-green-500 hover:bg-green-600 focus:ring-green-300'} text-white rounded-xl text-sm font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-opacity-50 min-w-[100px] flex items-center justify-center"
                                data-student-id="${student.id}"
                                data-current-status="${paidForThisWeek}"
                            >
                                <i class="fas ${paidForThisWeek ? 'fa-times' : 'fa-check'} mr-2"></i>
                                <span class="button-text">${paidForThisWeek ? 'ยกเลิก' : 'จ่ายแล้ว'}</span>
                            </button>
                        </div>
                        
                        ${paidForThisWeek && student.paidAmount && student.paidAmount !== currentWeek.amount ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                                <p class="text-xs text-yellow-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    จ่าย ${student.paidAmount} บาท (ต่างจากที่กำหนด ${currentWeek.amount - student.paidAmount > 0 ? 'ขาด' : 'เกิน'} ${Math.abs(currentWeek.amount - student.paidAmount)} บาท)
                                </p>
                            </div>
                        ` : ''}
                        
                        ${!paidForThisWeek ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    กรุณาระบุจำนวนเงินก่อนกดปุ่ม "จ่ายแล้ว"
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function updateClassMoneySummary() {
            const container = document.getElementById('classMoneySummary');
            
            try {
                // Calculate financial data
                await calculateFinancials();
                
                // Get total students and payment stats
                await loadStudents();
                const totalStudents = students.length;
                let totalPaidStudents = 0;
                
                // Count paid students across all weeks
                const paymentsRef = window.ref(db, 'payments');
                const paymentsSnapshot = await window.get(paymentsRef);
                const uniquePaidStudents = new Set();
                
                if (paymentsSnapshot.exists()) {
                    const paymentsData = paymentsSnapshot.val();
                    Object.values(paymentsData).forEach(payment => {
                        uniquePaidStudents.add(payment.studentId);
                    });
                }
                totalPaidStudents = uniquePaidStudents.size;
                
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 text-center">
                        <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-arrow-down text-green-600 text-lg"></i>
                        </div>
                        <p class="text-2xl font-bold text-green-700">${totalIncome.toLocaleString()}</p>
                        <p class="text-sm text-green-600 font-medium">รายรับรวม</p>
                        <p class="text-xs text-green-500 mt-1">เงินที่เก็บได้</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 rounded-xl p-4 text-center">
                        <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-arrow-up text-red-600 text-lg"></i>
                        </div>
                        <p class="text-2xl font-bold text-red-700">${totalExpense.toLocaleString()}</p>
                        <p class="text-sm text-red-600 font-medium">รายจ่ายรวม</p>
                        <p class="text-xs text-red-500 mt-1">เงินที่ใช้ไป</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4 text-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-wallet text-blue-600 text-lg"></i>
                        </div>
                        <p class="text-2xl font-bold text-blue-700">${remainingBalance.toLocaleString()}</p>
                        <p class="text-sm text-blue-600 font-medium">คงเหลือ</p>
                        <p class="text-xs text-blue-500 mt-1">เงินที่เหลือ</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-violet-50 border-2 border-purple-200 rounded-xl p-4 text-center">
                        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-users text-purple-600 text-lg"></i>
                        </div>
                        <p class="text-2xl font-bold text-purple-700">${totalPaidStudents}/${totalStudents}</p>
                        <p class="text-sm text-purple-600 font-medium">นักเรียนจ่ายแล้ว</p>
                        <p class="text-xs text-purple-500 mt-1">ทั้งหมดที่เคยจ่าย</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error updating class money summary:', error);
                container.innerHTML = `
                    <div class="col-span-4 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
                        <p class="text-red-600 text-sm">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                    </div>
                `;
            }
        }

        async function updateStudentPaymentStatus() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            const container = document.getElementById('studentPaymentStatus');
            
            try {
                const student = await getStudentData(currentUser.studentId);
                
                if (!student) {
                    container.innerHTML = '<p class="text-red-600">ไม่พบข้อมูลนักเรียน</p>';
                    return;
                }

                const weekInfo = currentWeek ? `สัปดาห์ที่ ${currentWeek.week} - จำนวน ${currentWeek.amount} บาท` : 'ยังไม่มีการกำหนดสัปดาห์การจ่าย';
                const isPaidForCurrentWeek = currentWeek && student.weekId === currentWeek.id && student.paid;
                
                container.innerHTML = `
                    <div class="p-6 ${isPaidForCurrentWeek ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} rounded-xl border-2">
                        <div class="flex items-center space-x-4 mb-6">
                            <div class="w-16 h-16 ${isPaidForCurrentWeek ? 'bg-green-100' : 'bg-red-100'} rounded-2xl flex items-center justify-center">
                                <i class="fas ${isPaidForCurrentWeek ? 'fa-check-circle text-green-600' : 'fa-clock text-red-600'} text-3xl"></i>
                            </div>
                            <div>
                                <h4 class="text-2xl font-bold ${isPaidForCurrentWeek ? 'text-green-800' : 'text-red-800'} mb-1">
                                    ${isPaidForCurrentWeek ? 'จ่ายเงินแล้ว' : 'ยังไม่ได้จ่ายเงิน'}
                                </h4>
                                <p class="text-lg ${isPaidForCurrentWeek ? 'text-green-600' : 'text-red-600'}">${weekInfo}</p>
                            </div>
                        </div>
                        
                        ${currentWeek ? `
                            <div class="bg-white/70 rounded-xl p-4 mb-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">สัปดาห์ปัจจุบัน</p>
                                        <p class="text-xl font-bold text-gray-800">สัปดาห์ที่ ${currentWeek.week}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">จำนวนเงิน</p>
                                        <p class="text-xl font-bold text-gray-800">${currentWeek.amount.toLocaleString()} บาท</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center space-x-2">
                            ${isPaidForCurrentWeek ? 
                                '<i class="fas fa-check-circle text-green-600"></i><p class="text-green-700 font-medium">ขอบคุณที่ชำระเงินตรงเวลา</p>' : 
                                '<i class="fas fa-exclamation-triangle text-red-600"></i><p class="text-red-700 font-medium">กรุณาชำระเงินให้เหรัญญิกห้อง</p>'
                            }
                        </div>
                    </div>
                `;
                
                // Update class money summary
                await updateClassMoneySummary();
                
                // Update payment history
                const historyContainer = document.getElementById('paymentHistory');
                const paymentHistory = await getPaymentHistory(currentUser.studentId);
                
                if (paymentHistory.length > 0) {
                    let historyHTML = '<div class="space-y-3">';
                    paymentHistory.forEach(payment => {
                        const paidDate = payment.paidAt ? new Date(payment.paidAt.seconds * 1000).toLocaleDateString('th-TH') : 'ไม่ระบุ';
                        historyHTML += `
                            <div class="p-4 bg-green-50 border border-green-200 rounded-xl hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-check text-green-600 text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-green-800">สัปดาห์ที่ ${payment.week}</p>
                                            <p class="text-xs text-green-600">จ่ายเมื่อ: ${paidDate}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-green-700">${payment.amount.toLocaleString()}</p>
                                        <p class="text-xs text-green-600">บาท</p>
                                    </div>
                                </div>
                                <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-check mr-1"></i>ชำระแล้ว
                                </span>
                            </div>
                        `;
                    });
                    historyHTML += '</div>';
                    
                    // Add summary
                    const totalPaid = paymentHistory.reduce((sum, payment) => sum + payment.amount, 0);
                    historyHTML += `
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-calculator text-blue-600"></i>
                                    <span class="font-medium text-blue-800">รวมที่จ่ายแล้ว</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-xl font-bold text-blue-700">${totalPaid.toLocaleString()}</p>
                                    <p class="text-sm text-blue-600">บาท (${paymentHistory.length} ครั้ง)</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    historyContainer.innerHTML = historyHTML;
                } else {
                    historyContainer.innerHTML = `
                        <div class="py-12 px-6 text-center text-gray-500">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-receipt text-gray-400 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">ยังไม่มีประวัติการจ่ายเงิน</h4>
                            <p class="text-gray-500 text-sm">เมื่อคุณชำระเงินแล้ว ประวัติจะแสดงที่นี่</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error updating student payment status:', error);
                container.innerHTML = '<p class="text-red-600">เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message + '</p>';
            }
        }

        // Modal Functions
        function openWithdrawModal() {
            document.getElementById('withdrawModal').classList.remove('hidden');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            // Update current balance
            document.getElementById('currentBalance').textContent = remainingBalance.toLocaleString() + ' บาท';
        }

        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.add('hidden');
            
            // Reset modal title and button
            document.getElementById('expenseModalTitle').textContent = 'ถอนเงิน/ใช้จ่าย';
            document.getElementById('saveExpenseBtn').innerHTML = '<i class="fas fa-save mr-2"></i> บันทึก';
            
            // Clear form
            document.getElementById('editingExpenseId').value = '';
            document.getElementById('expenseType').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseNote').value = '';
        }

        async function saveExpense(event) {
            event.preventDefault();
            const editingExpenseId = document.getElementById('editingExpenseId').value;
            const type = document.getElementById('expenseType').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const note = document.getElementById('expenseNote').value;
            const saveBtn = document.getElementById('saveExpenseBtn');
            
            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังบันทึก...';
                saveBtn.disabled = true;
                showLoading();
                
                // For editing, check if new amount exceeds balance (considering the old amount)
                if (editingExpenseId) {
                    const oldExpense = allExpenses.find(e => e.id === editingExpenseId);
                    const oldAmount = oldExpense ? oldExpense.amount : 0;
                    const balanceWithOldAmount = remainingBalance + oldAmount;
                    
                    if (amount > balanceWithOldAmount) {
                        showNotification(`จำนวนเงินเกินยอดคงเหลือ (${balanceWithOldAmount.toLocaleString()} บาท)`, 'error');
                        return;
                    }
                } else {
                    // For new expense, check if amount exceeds current balance
                    if (amount > remainingBalance) {
                        showNotification(`จำนวนเงินเกินยอดคงเหลือ (${remainingBalance.toLocaleString()} บาท)`, 'error');
                        return;
                    }
                }
                
                const expenseData = {
                    type: type,
                    description: description,
                    amount: amount,
                    date: date,
                    note: note || '',
                    createdBy: currentUser.uid
                };
                
                if (editingExpenseId) {
                    // Update existing expense
                    await updateExpense(editingExpenseId, expenseData);
                    showNotification(`✅ แก้ไขรายจ่าย ${description} สำเร็จ!`, 'success');
                } else {
                    // Add new expense
                    await addExpense(expenseData);
                    showNotification(`✅ บันทึกรายจ่าย ${amount.toLocaleString()} บาท สำเร็จ!`, 'success');
                }
                
                // Reload financial data and expense history
                await calculateFinancials();
                await updateAdminStats();
                
                // If we're on expense history page, reload it
                if (!document.getElementById('expenseHistoryDashboard').classList.contains('hidden')) {
                    await updateExpenseHistoryList();
                    updateExpenseHistorySummary();
                }
                
                closeWithdrawModal();
                
            } catch (error) {
                console.error('Error saving expense:', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึกรายจ่าย: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> บันทึก';
                saveBtn.disabled = false;
                hideLoading();
            }
        }

        async function showExpenseHistory() {
            hideAllScreens();
            document.getElementById('expenseHistoryDashboard').classList.remove('hidden');
            

            
            if (!isFirebaseConnected) {
                showNotification('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า', 'error');
                return;
            }

            try {
                showLoading();
                await calculateFinancials();
                updateExpenseHistorySummary();
                await updateExpenseHistoryList();
            } catch (error) {
                console.error('Error loading expense history:', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดประวัติการใช้เงิน: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function updateExpenseHistorySummary() {
            document.getElementById('summaryTotalIncome').textContent = totalIncome.toLocaleString();
            document.getElementById('summaryTotalExpense').textContent = totalExpense.toLocaleString();
            document.getElementById('summaryBalance').textContent = remainingBalance.toLocaleString();
        }

        async function updateExpenseHistoryList() {
            const container = document.getElementById('expenseHistoryList');
            const statusEl = document.getElementById('expenseListStatus');
            
            statusEl.textContent = `รายการทั้งหมด ${allExpenses.length} รายการ`;
            container.innerHTML = '';
            
            if (allExpenses.length === 0) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'py-16 px-6 text-center text-gray-500';
                emptyCard.innerHTML = `
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-receipt text-gray-400 text-3xl"></i>
                    </div>
                    <h4 class="text-xl font-semibold text-gray-700 mb-2">ยังไม่มีรายการใช้เงิน</h4>
                    <p class="text-gray-500">เพิ่มรายการแรกเพื่อเริ่มต้นติดตามการใช้เงิน</p>
                `;
                container.appendChild(emptyCard);
                return;
            }
            
            allExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date).toLocaleDateString('th-TH');
                const typeLabels = {
                    'supplies': 'อุปกรณ์การเรียน',
                    'cleaning': 'ของใช้ทำความสะอาด',
                    'decoration': 'ตกแต่งห้องเรียน',
                    'activity': 'กิจกรรมห้อง',
                    'food': 'อาหารและเครื่องดื่ม',
                    'repair': 'ซ่อมแซม',
                    'other': 'อื่นๆ'
                };
                
                const typeIcons = {
                    'supplies': 'fas fa-book',
                    'cleaning': 'fas fa-broom',
                    'decoration': 'fas fa-palette',
                    'activity': 'fas fa-users',
                    'food': 'fas fa-utensils',
                    'repair': 'fas fa-tools',
                    'other': 'fas fa-ellipsis-h'
                };
                
                const card = document.createElement('div');
                card.className = 'bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-gray-200 hover:shadow-lg transition-all';
                
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                                <i class="${typeIcons[expense.type] || 'fas fa-receipt'} text-red-600 text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h4 class="font-semibold text-gray-800">${expense.description}</h4>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">
                                        ${typeLabels[expense.type] || expense.type}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">วันที่: ${expenseDate}</p>
                                ${expense.note ? `<p class="text-sm text-gray-500 italic">${expense.note}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <p class="text-2xl font-bold text-red-600">-${expense.amount.toLocaleString()}</p>
                                <p class="text-sm text-red-500">บาท</p>
                            </div>
                            ${currentUser && currentUser.role === 'teacher' ? `
                                <div class="flex flex-col space-y-2">
                                    <button onclick="editExpense('${expense.id}')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium transition-all shadow-md hover:shadow-lg">
                                        <i class="fas fa-edit mr-1"></i> แก้ไข
                                    </button>
                                    <button onclick="deleteExpense('${expense.id}')" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-medium transition-all shadow-md hover:shadow-lg">
                                        <i class="fas fa-trash mr-1"></i> ลบ
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openWeekModal() {
            document.getElementById('weekModal').classList.remove('hidden');
        }

        function closeWeekModal() {
            document.getElementById('weekModal').classList.add('hidden');
            document.getElementById('weekModalTitle').textContent = 'เพิ่มสัปดาห์การจ่าย';
            document.getElementById('editingWeekId').value = '';
            document.getElementById('weekNumber').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('setWeekBtn').innerHTML = '<i class="fas fa-calendar-plus mr-2"></i> บันทึกสัปดาห์';
        }

        function openStudentModal() {
            document.getElementById('studentModal').classList.remove('hidden');
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.add('hidden');
            
            // Clear single student form
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentPrefix').value = '';
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentPassword').value = '123456';
            document.getElementById('studentRole').value = 'student';
            
            // Clear bulk import form
            document.getElementById('bulkStudentData').value = '';
            document.getElementById('bulkPassword').value = '123456';
            document.getElementById('previewSection').classList.add('hidden');
            
            // Reset to single tab
            switchTab('single');
        }

        function openStudentManagementModal() {
            document.getElementById('studentManagementModal').classList.remove('hidden');
            updateStudentManagementList();
        }

        function closeStudentManagementModal() {
            document.getElementById('studentManagementModal').classList.add('hidden');
        }

        function updateStudentManagementList() {
            const container = document.getElementById('studentManagementList');
            container.innerHTML = '';
            
            if (students.length === 0) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'py-12 px-6 text-center text-gray-500 bg-white/50 rounded-2xl border border-gray-200';
                emptyCard.innerHTML = `
                    <div class="text-4xl mb-3"><i class="fas fa-users"></i></div>
                    <p class="text-lg font-medium">ยังไม่มีนักเรียนในระบบ</p>
                    <p class="text-sm mt-1">เพิ่มนักเรียนก่อนเพื่อจัดการข้อมูล</p>
                `;
                container.appendChild(emptyCard);
                return;
            }
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'bg-white/70 backdrop-blur-sm rounded-2xl p-4 border border-gray-200 hover:shadow-lg transition-all';
                
                const isTreasurer = student.role === 'treasurer';
                
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 ${isTreasurer ? 'bg-yellow-100' : 'bg-purple-100'} rounded-xl flex items-center justify-center font-bold text-sm ${isTreasurer ? 'text-yellow-700' : 'text-purple-700'}">
                                ${isTreasurer ? '<i class="fas fa-crown"></i>' : student.number}
                            </div>
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-semibold text-gray-800 text-sm">${student.name}</h4>
                                    ${isTreasurer ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium"><i class="fas fa-crown mr-1"></i>เหรัญญิก</span>' : ''}
                                </div>
                                <p class="text-xs text-gray-500">รหัส: ${student.studentId}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editStudent('${student.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-all font-medium">
                                <i class="fas fa-edit mr-1"></i> แก้ไข
                            </button>
                            <button onclick="deleteStudent('${student.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-all font-medium">
                                <i class="fas fa-trash mr-1"></i> ลบ
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Week Management
        function editSelectedWeek() {
            if (!currentWeek) return;
            
            document.getElementById('weekModalTitle').textContent = 'แก้ไขสัปดาห์การจ่าย';
            document.getElementById('editingWeekId').value = currentWeek.id;
            document.getElementById('weekNumber').value = currentWeek.week;
            document.getElementById('paymentAmount').value = currentWeek.amount;
            document.getElementById('setWeekBtn').innerHTML = '<i class="fas fa-save mr-2"></i> บันทึกการแก้ไข';
            
            openWeekModal();
        }

        function deleteSelectedWeek() {
            if (!currentWeek) return;
            
            weekToDelete = currentWeek;
            document.getElementById('deleteWeekText').textContent = `สัปดาห์ที่ ${currentWeek.week}`;
            document.getElementById('deleteWeekAmount').textContent = `จำนวน ${currentWeek.amount} บาท`;
            
            document.getElementById('deleteWeekConfirmModal').classList.remove('hidden');
        }

        function closeDeleteWeekConfirmModal() {
            document.getElementById('deleteWeekConfirmModal').classList.add('hidden');
            weekToDelete = null;
        }

        async function confirmDeleteWeek() {
            if (!weekToDelete) return;
            
            const confirmBtn = document.getElementById('confirmDeleteWeekBtn');
            
            try {
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังลบ...';
                confirmBtn.disabled = true;
                showLoading();
                
                // Delete week record from current teacher's data
                const weekRef = window.ref(db, `teachers/${currentUser.uid}/weeks/${weekToDelete.id}`);
                await window.set(weekRef, null);
                
                // Delete payment history for this week from current teacher's data
                const paymentsRef = window.ref(db, `teachers/${currentUser.uid}/payments`);
                const paymentsSnapshot = await window.get(paymentsRef);
                if (paymentsSnapshot.exists()) {
                    const paymentsData = paymentsSnapshot.val();
                    const deletions = {};
                    Object.keys(paymentsData).forEach(paymentId => {
                        if (paymentsData[paymentId].weekId === weekToDelete.id) {
                            deletions[`teachers/${currentUser.uid}/payments/${paymentId}`] = null;
                        }
                    });
                    if (Object.keys(deletions).length > 0) {
                        await window.update(window.ref(db), deletions);
                    }
                }
                
                // Reset all students' payment status for this week in current teacher's data
                const studentsRef = window.ref(db, `teachers/${currentUser.uid}/students`);
                const studentsSnapshot = await window.get(studentsRef);
                if (studentsSnapshot.exists()) {
                    const studentsData = studentsSnapshot.val();
                    const updates = {};
                    Object.keys(studentsData).forEach(studentId => {
                        if (studentsData[studentId].weekId === weekToDelete.id) {
                            updates[`teachers/${currentUser.uid}/students/${studentId}/paid`] = false;
                            updates[`teachers/${currentUser.uid}/students/${studentId}/weekId`] = null;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await window.update(window.ref(db), updates);
                    }
                }
                
                // Reload data
                await loadCurrentWeek();
                await loadStudents();
                updateWeekSelector();
                
                // Reset selection
                selectedWeekId = null;
                currentWeek = null;
                document.getElementById('weekSelector').value = '';
                hideSelectedWeekInfo();
                showNoWeekSelected();
                updateAdminStats();
                
                closeDeleteWeekConfirmModal();
                showNotification(`✅ ลบสัปดาห์ที่ ${weekToDelete.week} สำเร็จ`, 'success');
                
            } catch (error) {
                console.error('Error deleting week:', error);
                showNotification('เกิดข้อผิดพลาดในการลบสัปดาห์: ' + error.message, 'error');
            } finally {
                confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> ลบสัปดาห์';
                confirmBtn.disabled = false;
                hideLoading();
            }
        }

        async function savePaymentWeek(event) {
            event.preventDefault();
            const weekNumber = document.getElementById('weekNumber').value;
            const amount = document.getElementById('paymentAmount').value;
            const editingWeekId = document.getElementById('editingWeekId').value;
            const setWeekBtn = document.getElementById('setWeekBtn');
            
            try {
                setWeekBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังบันทึก...';
                setWeekBtn.disabled = true;
                showLoading();
                
                // Check if week number already exists (for new weeks or different week when editing)
                const existingWeek = allWeeks.find(w => w.week === parseInt(weekNumber) && w.id !== editingWeekId);
                if (existingWeek) {
                    showNotification(`สัปดาห์ที่ ${weekNumber} มีอยู่แล้ว`, 'error');
                    return;
                }
                
                const weekData = {
                    week: parseInt(weekNumber),
                    amount: parseInt(amount)
                };
                
                let newWeekId = null;
                
                if (editingWeekId) {
                    // Update existing week in current teacher's data
                    const weekRef = window.ref(db, `teachers/${currentUser.uid}/weeks/${editingWeekId}`);
                    await window.update(weekRef, {
                        ...weekData,
                        lastUpdated: window.serverTimestamp()
                    });
                    
                    newWeekId = editingWeekId;
                    showNotification(`✅ แก้ไขสัปดาห์ที่ ${weekNumber} สำเร็จ!`, 'success');
                } else {
                    // Add new week
                    const newWeekRef = await addPaymentWeek(weekData);
                    newWeekId = newWeekRef.key;
                    showNotification(`✅ เพิ่มสัปดาห์ที่ ${weekNumber} จำนวน ${amount} บาท สำเร็จ!`, 'success');
                }
                
                // Reload data
                await loadCurrentWeek();
                updateWeekSelector();
                
                // Auto-select the new/edited week and show students
                if (newWeekId) {
                    selectedWeekId = newWeekId;
                    currentWeek = allWeeks.find(w => w.id === newWeekId);
                    
                    // Update the selector to show the selected week
                    document.getElementById('weekSelector').value = selectedWeekId;
                    
                    // Update the week info display
                    updateSelectedWeekInfo();
                    
                    // Load and display students for this week
                    await loadStudentsForWeek();
                }
                
                closeWeekModal();
                
            } catch (error) {
                console.error('Error saving payment week:', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึกสัปดาห์', 'error');
            } finally {
                setWeekBtn.innerHTML = '<i class="fas fa-calendar-plus mr-2"></i> บันทึกสัปดาห์';
                setWeekBtn.disabled = false;
                hideLoading();
            }
        }

        // Tab Management
        function switchTab(tabName) {
            const singleTab = document.getElementById('singleTab');
            const bulkTab = document.getElementById('bulkTab');
            const singleForm = document.getElementById('singleStudentForm');
            const bulkForm = document.getElementById('bulkImportForm');
            
            if (tabName === 'single') {
                singleTab.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-white text-purple-600 shadow-sm';
                bulkTab.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600';
                singleForm.classList.remove('hidden');
                bulkForm.classList.add('hidden');
            } else {
                bulkTab.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all bg-white text-purple-600 shadow-sm';
                singleTab.className = 'flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-purple-600';
                bulkForm.classList.remove('hidden');
                singleForm.classList.add('hidden');
            }
        }

        // Edit Student Functions
        let studentToDelete = null;

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Parse the name to extract prefix, first name, and last name
            const nameParts = student.name.match(/^(นาย|นางสาว|เด็กชาย|เด็กหญิง)(.+)$/);
            let prefix = '';
            let fullName = student.name;
            
            if (nameParts) {
                prefix = nameParts[1];
                fullName = nameParts[2].trim();
            }
            
            const nameWords = fullName.split(' ');
            const firstName = nameWords[0] || '';
            const lastName = nameWords.slice(1).join(' ') || '';

            // Fill the edit form
            document.getElementById('editStudentOriginalId').value = studentId;
            document.getElementById('editStudentNumber').value = student.number;
            document.getElementById('editStudentId').value = student.studentId;
            document.getElementById('editStudentPrefix').value = prefix;
            document.getElementById('editStudentFirstName').value = firstName;
            document.getElementById('editStudentLastName').value = lastName;
            document.getElementById('editStudentPassword').value = student.password || '123456';
            document.getElementById('editStudentRole').value = student.role || 'student';

            // Show the edit modal
            document.getElementById('editStudentModal').classList.remove('hidden');
        }

        function closeEditStudentModal() {
            document.getElementById('editStudentModal').classList.add('hidden');
            
            // Clear form
            document.getElementById('editStudentOriginalId').value = '';
            document.getElementById('editStudentNumber').value = '';
            document.getElementById('editStudentId').value = '';
            document.getElementById('editStudentPrefix').value = '';
            document.getElementById('editStudentFirstName').value = '';
            document.getElementById('editStudentLastName').value = '';
            document.getElementById('editStudentPassword').value = '';
            document.getElementById('editStudentRole').value = '';
        }

        async function updateStudent(event) {
            event.preventDefault();
            const originalId = document.getElementById('editStudentOriginalId').value;
            const studentNumber = document.getElementById('editStudentNumber').value;
            const newStudentId = document.getElementById('editStudentId').value;
            const prefix = document.getElementById('editStudentPrefix').value;
            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const password = document.getElementById('editStudentPassword').value;
            const role = document.getElementById('editStudentRole').value;
            const updateBtn = document.getElementById('updateStudentBtn');
            
            try {
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังบันทึก...';
                updateBtn.disabled = true;
                showLoading();
                
                const student = students.find(s => s.id === originalId);
                if (!student) {
                    throw new Error('ไม่พบข้อมูลนักเรียน');
                }

                // Check if new student ID already exists (and it's not the same student)
                if (newStudentId !== student.studentId) {
                    const existingStudent = await getStudentData(newStudentId);
                    if (existingStudent) {
                        throw new Error('รหัสนักเรียนนี้มีอยู่แล้ว');
                    }
                }
                
                const fullName = `${prefix}${firstName} ${lastName}`;
                
                const updatedData = {
                    number: studentNumber,
                    studentId: newStudentId,
                    name: fullName,
                    password: password,
                    role: role,
                    paid: student.paid, // Keep existing payment status
                    lastUpdated: window.serverTimestamp()
                };

                // If student ID changed, we need to delete old record and create new one
                if (newStudentId !== student.studentId) {
                    // Delete old record from current teacher's data
                    const oldStudentRef = window.ref(db, `teachers/${currentUser.uid}/students/${student.studentId}`);
                    await window.set(oldStudentRef, null);
                    
                    // Create new record in current teacher's data
                    const newStudentRef = window.ref(db, `teachers/${currentUser.uid}/students/${newStudentId}`);
                    await window.set(newStudentRef, updatedData);
                    
                    // Update payment history if exists in current teacher's data
                    const paymentsRef = window.ref(db, `teachers/${currentUser.uid}/payments`);
                    const paymentsSnapshot = await window.get(paymentsRef);
                    if (paymentsSnapshot.exists()) {
                        const paymentsData = paymentsSnapshot.val();
                        const updates = {};
                        Object.keys(paymentsData).forEach(paymentId => {
                            if (paymentsData[paymentId].studentId === student.studentId) {
                                updates[`teachers/${currentUser.uid}/payments/${paymentId}/studentId`] = newStudentId;
                            }
                        });
                        if (Object.keys(updates).length > 0) {
                            await window.update(window.ref(db), updates);
                        }
                    }
                } else {
                    // Just update existing record in current teacher's data
                    const studentRef = window.ref(db, `teachers/${currentUser.uid}/students/${student.studentId}`);
                    await window.update(studentRef, updatedData);
                }
                
                // Reload students
                await loadStudents();
                updateAdminStats();
                updateStudentsTable();
                updateStudentManagementList();
                
                closeEditStudentModal();
                showNotification(`✅ แก้ไขข้อมูล ${fullName} สำเร็จ!`, 'success');
                
            } catch (error) {
                console.error('Error updating student:', error);
                showNotification('เกิดข้อผิดพลาดในการแก้ไขข้อมูล: ' + error.message, 'error');
            } finally {
                updateBtn.innerHTML = '<i class="fas fa-save mr-2"></i> บันทึกการแก้ไข';
                updateBtn.disabled = false;
                hideLoading();
            }
        }

        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            studentToDelete = student;
            
            // Fill delete confirmation modal
            document.getElementById('deleteStudentNumber').textContent = student.number;
            document.getElementById('deleteStudentName').textContent = student.name;
            document.getElementById('deleteStudentId').textContent = student.studentId;
            
            // Show delete confirmation modal
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            studentToDelete = null;
        }

        async function confirmDeleteStudent() {
            if (!studentToDelete) return;
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            try {
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังลบ...';
                confirmBtn.disabled = true;
                showLoading();
                
                // Delete student record from current teacher's data
                const studentRef = window.ref(db, `teachers/${currentUser.uid}/students/${studentToDelete.studentId}`);
                await window.set(studentRef, null);
                
                // Delete payment history from current teacher's data
                const paymentsRef = window.ref(db, `teachers/${currentUser.uid}/payments`);
                const paymentsSnapshot = await window.get(paymentsRef);
                if (paymentsSnapshot.exists()) {
                    const paymentsData = paymentsSnapshot.val();
                    const deletions = {};
                    Object.keys(paymentsData).forEach(paymentId => {
                        if (paymentsData[paymentId].studentId === studentToDelete.studentId) {
                            deletions[`teachers/${currentUser.uid}/payments/${paymentId}`] = null;
                        }
                    });
                    if (Object.keys(deletions).length > 0) {
                        await window.update(window.ref(db), deletions);
                    }
                }
                
                // Reload students
                await loadStudents();
                updateAdminStats();
                updateStudentsTable();
                updateStudentManagementList();
                
                closeDeleteConfirmModal();
                showNotification(`✅ ลบ ${studentToDelete.name} ออกจากระบบสำเร็จ`, 'success');
                
            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification('เกิดข้อผิดพลาดในการลบนักเรียน: ' + error.message, 'error');
            } finally {
                confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> ลบนักเรียน';
                confirmBtn.disabled = false;
                hideLoading();
            }
        }

        // Student Management
        async function addSingleStudent(event) {
            event.preventDefault();
            const studentNumber = document.getElementById('studentNumber').value;
            const studentId = document.getElementById('studentId').value;
            const prefix = document.getElementById('studentPrefix').value;
            const firstName = document.getElementById('studentFirstName').value;
            const lastName = document.getElementById('studentLastName').value;
            const password = document.getElementById('studentPassword').value;
            const role = document.getElementById('studentRole').value;
            const addBtn = document.getElementById('addStudentBtn');
            
            try {
                addBtn.textContent = 'กำลังเพิ่ม...';
                addBtn.disabled = true;
                showLoading();
                
                // Check if student ID already exists
                const existingStudent = await getStudentData(studentId);
                if (existingStudent) {
                    showNotification('รหัสนักเรียนนี้มีอยู่แล้ว', 'error');
                    return;
                }
                
                const fullName = `${prefix}${firstName} ${lastName}`;
                
                const studentData = {
                    number: studentNumber,
                    studentId: studentId,
                    name: fullName,
                    password: password,
                    role: role,
                    paid: false
                };
                
                await addStudent(studentData);
                
                // Reload students
                await loadStudents();
                updateAdminStats();
                updateStudentsTable();
                
                closeStudentModal();
                showNotification(`✅ เพิ่ม ${fullName} สำเร็จ!\n🆔 รหัสนักเรียน: ${studentId}\n🔑 รหัสผ่าน: ${password}`, 'success');
                
            } catch (error) {
                console.error('Error adding student:', error);
                showNotification('เกิดข้อผิดพลาดในการเพิ่มนักเรียน', 'error');
            } finally {
                addBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> เพิ่มนักเรียน';
                addBtn.disabled = false;
                hideLoading();
            }
        }

        // Bulk Import Functions
        function previewBulkData() {
            const data = document.getElementById('bulkStudentData').value.trim();
            const previewSection = document.getElementById('previewSection');
            const previewData = document.getElementById('previewData');
            const previewBtn = document.getElementById('previewBulkBtn');
            
            if (!data) {
                showNotification('กรุณาใส่ข้อมูลนักเรียนก่อน', 'warning');
                return;
            }
            
            try {
                // Show loading state
                const originalHTML = previewBtn.innerHTML;
                previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังประมวลผล...';
                previewBtn.disabled = true;
                
                const parsedData = parseBulkData(data);
                
                if (parsedData.length === 0) {
                    showNotification('ไม่พบข้อมูลที่ถูกต้อง กรุณาตรวจสอบรูปแบบข้อมูล', 'error');
                    previewBtn.innerHTML = originalHTML;
                    previewBtn.disabled = false;
                    return;
                }
                
                let previewHTML = '<div class="space-y-2">';
                parsedData.forEach((student, index) => {
                    const isValid = student.number && student.studentId && student.prefix && student.firstName && student.lastName;
                    previewHTML += `
                        <div class="flex items-center justify-between p-3 ${isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg">
                            <div class="flex items-center space-x-3">
                                <span class="w-8 h-8 ${isValid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-lg flex items-center justify-center text-sm font-bold">
                                    ${student.number || '?'}
                                </span>
                                <div>
                                    <p class="font-medium text-sm">${student.prefix || '?'}${student.firstName || '?'} ${student.lastName || '?'}</p>
                                    <p class="text-xs text-gray-500">รหัส: ${student.studentId || '?'}</p>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${isValid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${isValid ? '✓ ถูกต้อง' : '✗ ข้อมูลไม่ครบ'}
                            </span>
                        </div>
                    `;
                });
                previewHTML += '</div>';
                
                previewData.innerHTML = previewHTML;
                previewSection.classList.remove('hidden');
                
                const validCount = parsedData.filter(s => s.number && s.studentId && s.prefix && s.firstName && s.lastName).length;
                const invalidCount = parsedData.length - validCount;
                
                let message = `พบข้อมูล ${parsedData.length} รายการ (ถูกต้อง ${validCount} รายการ`;
                if (invalidCount > 0) {
                    message += `, ไม่ถูกต้อง ${invalidCount} รายการ`;
                }
                message += ')';
                
                showNotification(message, validCount > 0 ? 'success' : 'warning');
                
                // Restore button
                previewBtn.innerHTML = originalHTML;
                previewBtn.disabled = false;
                
            } catch (error) {
                console.error('Error parsing bulk data:', error);
                showNotification('รูปแบบข้อมูลไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง', 'error');
                
                // Restore button on error
                previewBtn.innerHTML = '<i class="fas fa-eye mr-2"></i> ดูตัวอย่าง';
                previewBtn.disabled = false;
            }
        }

        function parseBulkData(data) {
            const lines = data.split('\n').filter(line => line.trim());
            const students = [];
            
            lines.forEach((line, index) => {
                // Try different separators: tab, multiple spaces, single space
                let parts = [];
                
                // First try tab separator
                if (line.includes('\t')) {
                    parts = line.split('\t');
                } else {
                    // Try multiple spaces (2 or more)
                    parts = line.split(/\s{2,}/);
                    
                    // If still not enough parts, try single space
                    if (parts.length < 5) {
                        parts = line.split(/\s+/);
                    }
                }
                
                // Clean up parts and ensure we have at least 5 parts
                parts = parts.map(part => part?.trim()).filter(part => part);
                
                if (parts.length >= 5) {
                    students.push({
                        number: parts[0] || '',
                        studentId: parts[1] || '',
                        prefix: parts[2] || '',
                        firstName: parts[3] || '',
                        lastName: parts[4] || ''
                    });
                } else if (parts.length > 0) {
                    // Add incomplete data for debugging
                    students.push({
                        number: parts[0] || '',
                        studentId: parts[1] || '',
                        prefix: parts[2] || '',
                        firstName: parts[3] || '',
                        lastName: parts[4] || ''
                    });
                }
            });
            
            return students;
        }

        async function importBulkStudents() {
            const data = document.getElementById('bulkStudentData').value.trim();
            const password = document.getElementById('bulkPassword').value;
            const importBtn = document.getElementById('importBulkBtn');
            
            if (!data) {
                showNotification('กรุณาใส่ข้อมูลนักเรียนก่อน', 'warning');
                return;
            }
            
            try {
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังนำเข้า...';
                importBtn.disabled = true;
                showLoading();
                
                const parsedData = parseBulkData(data);
                const validStudents = parsedData.filter(s => s.number && s.studentId && s.prefix && s.firstName && s.lastName);
                
                if (validStudents.length === 0) {
                    showNotification('ไม่พบข้อมูลที่ถูกต้อง', 'error');
                    return;
                }
                
                let addedCount = 0;
                let duplicateCount = 0;
                
                for (const student of validStudents) {
                    try {
                        const existingStudent = await getStudentData(student.studentId);
                        if (!existingStudent) {
                            const fullName = `${student.prefix}${student.firstName} ${student.lastName}`;
                            const studentData = {
                                number: student.number,
                                studentId: student.studentId,
                                name: fullName,
                                password: password,
                                role: 'student', // นักเรียนทั่วไปเป็นค่าเริ่มต้น
                                paid: false
                            };
                            await addStudent(studentData);
                            addedCount++;
                        } else {
                            duplicateCount++;
                        }
                    } catch (error) {
                        console.error(`Error adding student ${student.studentId}:`, error);
                    }
                }
                
                // Reload students
                await loadStudents();
                updateAdminStats();
                updateStudentsTable();
                
                closeStudentModal();
                
                let message = `✅ นำเข้าข้อมูลสำเร็จ!\n📊 เพิ่มนักเรียน: ${addedCount} คน`;
                if (duplicateCount > 0) {
                    message += `\n⚠️ ข้าม (รหัสซ้ำ): ${duplicateCount} คน`;
                }
                message += `\n🔑 รหัสผ่านเริ่มต้น: ${password}`;
                
                showNotification(message, 'success');
                
            } catch (error) {
                console.error('Error importing bulk students:', error);
                showNotification('เกิดข้อผิดพลาดในการนำเข้าข้อมูล', 'error');
            } finally {
                importBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> นำเข้าข้อมูล';
                importBtn.disabled = false;
                hideLoading();
            }
        }

        // Function to validate payment amount
        function validatePaymentAmount(studentId) {
            const amountInput = document.getElementById(`amount_${studentId}`);
            const button = document.getElementById(`payBtn_${studentId}`);
            
            if (!amountInput || !button) return;
            
            const amount = parseFloat(amountInput.value);
            const student = students.find(s => s.id === studentId);
            const isPaid = student && student.weekId === selectedWeekId && student.paid;
            
            // If already paid, don't allow changes
            if (isPaid) return;
            
            // Update button state based on amount validity
            if (isNaN(amount) || amount <= 0) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                button.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i><span>ระบุจำนวนเงิน</span>';
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.innerHTML = '<i class="fas fa-check mr-2"></i><span>จ่ายแล้ว</span>';
            }
        }

        async function togglePayment(studentId) {
            if (!isFirebaseConnected) {
                showNotification('ไม่สามารถเชื่อมต่อ Firebase ได้', 'error');
                return;
            }

            if (!selectedWeekId || !currentWeek) {
                showNotification('กรุณาเลือกสัปดาห์การจ่ายก่อน', 'warning');
                return;
            }

            const button = document.getElementById(`payBtn_${studentId}`);
            const amountInput = document.getElementById(`amount_${studentId}`);
            if (!button) return;

            try {
                const student = students.find(s => s.id === studentId);
                if (!student) {
                    throw new Error('ไม่พบข้อมูลนักเรียน');
                }

                // Check current payment status for this specific week
                const currentPaidStatus = student.weekId === selectedWeekId && student.paid;
                const newPaidStatus = !currentPaidStatus;
                
                let paidAmount = null;
                
                if (newPaidStatus) {
                    // For new payment, validate amount first
                    if (amountInput) {
                        paidAmount = parseFloat(amountInput.value);
                        if (isNaN(paidAmount) || paidAmount <= 0) {
                            showNotification('กรุณาระบุจำนวนเงินที่ถูกต้อง (มากกว่า 0)', 'error');
                            amountInput.focus();
                            return;
                        }
                    } else {
                        paidAmount = currentWeek.amount;
                    }
                }

                // Show loading state on button
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>กำลังอัพเดท...</span>';
                button.disabled = true;
                button.classList.add('opacity-75', 'cursor-not-allowed');
                
                // Update Firebase
                await updateStudentPayment(studentId, newPaidStatus, selectedWeekId, paidAmount);
                
                // Update local data immediately
                student.paid = newPaidStatus;
                student.weekId = newPaidStatus ? selectedWeekId : null;
                student.paidAmount = newPaidStatus ? paidAmount : null;
                
                // Update UI immediately without full reload
                updateSingleStudentUI(studentId, newPaidStatus, paidAmount);
                updateAdminStats();
                
                const action = newPaidStatus ? 'จ่ายแล้ว' : 'ยกเลิกการจ่าย';
                const amountText = newPaidStatus && paidAmount ? ` (${paidAmount.toLocaleString()} บาท)` : '';
                showNotification(`✅ อัพเดทสถานะ ${student.name} เป็น ${action}${amountText}`, 'success');
                
            } catch (error) {
                console.error('Error toggling payment:', error);
                showNotification('เกิดข้อผิดพลาดในการอัพเดทสถานะ: ' + error.message, 'error');
                
                // Restore button state on error
                const button = document.getElementById(`payBtn_${studentId}`);
                if (button) {
                    button.disabled = false;
                    button.classList.remove('opacity-75', 'cursor-not-allowed');
                    // Restore original state
                    const student = students.find(s => s.id === studentId);
                    const currentStatus = student && student.weekId === selectedWeekId && student.paid;
                    updateButtonState(button, currentStatus);
                }
            }
        }

        function updateSingleStudentUI(studentId, newPaidStatus, paidAmount = null) {
            const button = document.getElementById(`payBtn_${studentId}`);
            const amountInput = document.getElementById(`amount_${studentId}`);
            if (!button) return;

            // Update button state
            updateButtonState(button, newPaidStatus);

            // Enable/disable amount input and update styling
            if (amountInput) {
                if (newPaidStatus) {
                    // Paid status - disable and gray out input
                    amountInput.disabled = true;
                    amountInput.readOnly = true;
                    amountInput.className = 'w-full px-3 py-2 bg-gray-100 cursor-not-allowed border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm';
                    amountInput.value = paidAmount || currentWeek.amount;
                } else {
                    // Unpaid status - enable input
                    amountInput.disabled = false;
                    amountInput.readOnly = false;
                    amountInput.className = 'w-full px-3 py-2 bg-white/70 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm';
                    amountInput.value = currentWeek.amount;
                    // Add onchange event to validate amount
                    amountInput.setAttribute('onchange', `validatePaymentAmount('${studentId}')`);
                    // Trigger validation immediately
                    validatePaymentAmount(studentId);
                }
            }

            // Update status badge
            const card = button.closest('.bg-white\\/70');
            if (card) {
                const statusBadge = card.querySelector('span.px-4');
                const numberBadge = card.querySelector('.w-12.h-12');
                
                if (statusBadge) {
                    statusBadge.className = `px-4 py-2 rounded-full text-sm font-medium ${newPaidStatus ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                    statusBadge.innerHTML = newPaidStatus ? '<i class="fas fa-check-circle mr-2"></i> จ่ายแล้ว' : '<i class="fas fa-clock mr-2"></i> ยังไม่จ่าย';
                }
                
                if (numberBadge) {
                    numberBadge.className = `w-12 h-12 ${newPaidStatus ? 'bg-green-100' : 'bg-red-100'} rounded-xl flex items-center justify-center font-bold text-sm ${newPaidStatus ? 'text-green-700' : 'text-red-700'}`;
                }

                // Update card border
                card.className = `bg-white/70 backdrop-blur-sm rounded-2xl p-4 border border-gray-200 hover:shadow-lg transition-all ${newPaidStatus ? 'border-green-300 bg-green-50/50' : 'border-red-300 bg-red-50/50'}`;
                
                // Remove existing warning/info messages
                const existingWarning = card.querySelector('.bg-yellow-50');
                const existingInfo = card.querySelector('.bg-blue-50');
                if (existingWarning) existingWarning.remove();
                if (existingInfo) existingInfo.remove();
                
                // Add appropriate message based on status
                const spaceDiv = card.querySelector('.space-y-4');
                if (spaceDiv) {
                    if (newPaidStatus) {
                        // Show amount difference warning if applicable
                        if (paidAmount && paidAmount !== currentWeek.amount) {
                            const warningHTML = `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                                    <p class="text-xs text-yellow-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        จ่าย ${paidAmount.toLocaleString()} บาท (ต่างจากที่กำหนด ${currentWeek.amount - paidAmount > 0 ? 'ขาด' : 'เกิน'} ${Math.abs(currentWeek.amount - paidAmount).toLocaleString()} บาท)
                                    </p>
                                </div>
                            `;
                            spaceDiv.insertAdjacentHTML('beforeend', warningHTML);
                        }
                    } else {
                        // Show instruction for unpaid status
                        const infoHTML = `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    กรุณาระบุจำนวนเงินก่อนกดปุ่ม "จ่ายแล้ว"
                                </p>
                            </div>
                        `;
                        spaceDiv.insertAdjacentHTML('beforeend', infoHTML);
                    }
                }
            }
        }

        function updateButtonState(button, isPaid) {
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
            button.className = `px-6 py-3 ${isPaid ? 'bg-red-500 hover:bg-red-600 focus:ring-red-300' : 'bg-green-500 hover:bg-green-600 focus:ring-green-300'} text-white rounded-xl text-sm font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-opacity-50 min-w-[100px] flex items-center justify-center`;
            button.innerHTML = `
                <i class="fas ${isPaid ? 'fa-times' : 'fa-check'} mr-2"></i>
                <span class="button-text">${isPaid ? 'ยกเลิก' : 'จ่ายแล้ว'}</span>
            `;
            button.setAttribute('data-current-status', isPaid);
        }

        // Change Password Functions
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        async function changePassword(event) {
            event.preventDefault();
            
            if (!currentUser || (currentUser.role !== 'student' && currentUser.role !== 'treasurer')) {
                showNotification('ฟังก์ชันนี้สำหรับนักเรียนและเหรัญญิกเท่านั้น', 'error');
                return;
            }

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const changeBtn = document.getElementById('changePasswordBtn');
            
            try {
                changeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังเปลี่ยน...';
                changeBtn.disabled = true;
                showLoading();
                
                // Validate new password
                if (newPassword.length < 4) {
                    throw new Error('รหัสผ่านใหม่ต้องมีอย่างน้อย 4 ตัวอักษร');
                }
                
                if (newPassword !== confirmNewPassword) {
                    throw new Error('รหัสผ่านใหม่และการยืนยันไม่ตรงกัน');
                }
                
                if (newPassword === currentPassword) {
                    throw new Error('รหัสผ่านใหม่ต้องแตกต่างจากรหัสผ่านเดิม');
                }
                
                // Get current student data to verify current password
                const studentData = await getStudentData(currentUser.studentId);
                if (!studentData) {
                    throw new Error('ไม่พบข้อมูลนักเรียน');
                }
                
                if (studentData.password !== currentPassword) {
                    throw new Error('รหัสผ่านปัจจุบันไม่ถูกต้อง');
                }
                
                // Update password in Firebase
                const studentRef = window.ref(db, `students/${currentUser.studentId}`);
                await window.update(studentRef, {
                    password: newPassword,
                    lastPasswordChange: window.serverTimestamp()
                });
                
                closeChangePasswordModal();
                
                const userType = currentUser.role === 'treasurer' ? 'เหรัญญิก' : 'นักเรียน';
                showNotification(`✅ เปลี่ยนรหัสผ่าน${userType}สำเร็จ! กรุณาจำรหัสผ่านใหม่ไว้`, 'success');
                
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน: ' + error.message, 'error');
            } finally {
                changeBtn.innerHTML = '<i class="fas fa-key mr-2"></i> เปลี่ยนรหัสผ่าน';
                changeBtn.disabled = false;
                hideLoading();
            }
        }

        // Expense Management Functions
        function editExpense(expenseId) {
            const expense = allExpenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Fill the form with existing data
            document.getElementById('expenseModalTitle').textContent = 'แก้ไขรายจ่าย';
            document.getElementById('saveExpenseBtn').innerHTML = '<i class="fas fa-save mr-2"></i> บันทึกการแก้ไข';
            document.getElementById('editingExpenseId').value = expenseId;
            document.getElementById('expenseType').value = expense.type;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseNote').value = expense.note || '';

            // Update current balance display (add back the old amount)
            const balanceWithOldAmount = remainingBalance + expense.amount;
            document.getElementById('currentBalance').textContent = balanceWithOldAmount.toLocaleString() + ' บาท';

            // Show the modal
            document.getElementById('withdrawModal').classList.remove('hidden');
        }

        function deleteExpense(expenseId) {
            const expense = allExpenses.find(e => e.id === expenseId);
            if (!expense) return;

            expenseToDelete = expense;
            
            // Fill delete confirmation modal
            document.getElementById('deleteExpenseDescription').textContent = expense.description;
            document.getElementById('deleteExpenseAmount').textContent = `จำนวน ${expense.amount.toLocaleString()} บาท`;
            document.getElementById('deleteExpenseDate').textContent = `วันที่: ${new Date(expense.date).toLocaleDateString('th-TH')}`;
            
            // Show delete confirmation modal
            document.getElementById('deleteExpenseConfirmModal').classList.remove('hidden');
        }

        function closeDeleteExpenseConfirmModal() {
            document.getElementById('deleteExpenseConfirmModal').classList.add('hidden');
            expenseToDelete = null;
        }

        async function confirmDeleteExpense() {
            if (!expenseToDelete) return;
            
            const confirmBtn = document.getElementById('confirmDeleteExpenseBtn');
            
            try {
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังลบ...';
                confirmBtn.disabled = true;
                showLoading();
                
                // Delete expense from Firebase
                await deleteExpenseFromDB(expenseToDelete.id);
                
                // Reload financial data and expense history
                await calculateFinancials();
                await updateAdminStats();
                
                // If we're on expense history page, reload it
                if (!document.getElementById('expenseHistoryDashboard').classList.contains('hidden')) {
                    await updateExpenseHistoryList();
                    updateExpenseHistorySummary();
                }
                
                closeDeleteExpenseConfirmModal();
                showNotification(`✅ ลบรายการ ${expenseToDelete.description} สำเร็จ`, 'success');
                
            } catch (error) {
                console.error('Error deleting expense:', error);
                showNotification('เกิดข้อผิดพลาดในการลบรายการ: ' + error.message, 'error');
            } finally {
                confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> ลบรายการ';
                confirmBtn.disabled = false;
                hideLoading();
            }
        }

        // Utility Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationCard = document.getElementById('notificationCard');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const progressBar = document.getElementById('notificationProgressBar');
            
            // Clean message (remove emojis and extra characters)
            const cleanMessage = message.replace(/[🎉👋✅⚠️❌]/g, '').trim();
            
            // Set title, icon, and colors based on type
            if (type === 'success') {
                titleEl.textContent = 'สำเร็จ';
                icon.className = 'flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg bg-gradient-to-br from-green-500 to-emerald-600';
                icon.innerHTML = '<i class="fas fa-check text-white text-lg"></i>';
                notificationCard.className = 'bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-5 transform transition-all duration-300 ease-out';
                progressBar.className = 'h-full bg-gradient-to-r from-green-500 to-emerald-600 transition-all duration-75 ease-linear rounded-full';
            } else if (type === 'error') {
                titleEl.textContent = 'เกิดข้อผิดพลาด';
                icon.className = 'flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg bg-gradient-to-br from-red-500 to-rose-600';
                icon.innerHTML = '<i class="fas fa-exclamation-triangle text-white text-lg"></i>';
                notificationCard.className = 'bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-5 transform transition-all duration-300 ease-out';
                progressBar.className = 'h-full bg-gradient-to-r from-red-500 to-rose-600 transition-all duration-75 ease-linear rounded-full';
            } else if (type === 'warning') {
                titleEl.textContent = 'คำเตือน';
                icon.className = 'flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg bg-gradient-to-br from-yellow-500 to-orange-600';
                icon.innerHTML = '<i class="fas fa-exclamation text-white text-lg"></i>';
                notificationCard.className = 'bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-5 transform transition-all duration-300 ease-out';
                progressBar.className = 'h-full bg-gradient-to-r from-yellow-500 to-orange-600 transition-all duration-75 ease-linear rounded-full';
            } else if (type === 'info') {
                titleEl.textContent = 'ข้อมูล';
                icon.className = 'flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg bg-gradient-to-br from-blue-500 to-indigo-600';
                icon.innerHTML = '<i class="fas fa-info text-white text-lg"></i>';
                notificationCard.className = 'bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-5 transform transition-all duration-300 ease-out';
                progressBar.className = 'h-full bg-gradient-to-r from-blue-500 to-indigo-600 transition-all duration-75 ease-linear rounded-full';
            }
            
            messageEl.textContent = cleanMessage;
            
            // Show notification with animation
            notification.classList.remove('hidden');
            
            // Animate progress bar
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 100);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            const notificationCard = document.getElementById('notificationCard');
            const progressBar = document.getElementById('notificationProgressBar');
            
            // Add fade out animation
            notificationCard.style.transform = 'translateX(100%) scale(0.95)';
            notificationCard.style.opacity = '0';
            
            // Reset progress bar
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                notification.classList.add('hidden');
                // Reset transform for next notification
                notificationCard.style.transform = 'translateX(0) scale(1)';
                notificationCard.style.opacity = '1';
            }, 300);
        }

        // Guide Tab Management
        function switchGuideTab(tabName) {
            const teacherTab = document.getElementById('teacherGuideTab');
            const studentTab = document.getElementById('studentGuideTab');
            const teacherGuide = document.getElementById('teacherGuide');
            const studentGuide = document.getElementById('studentGuide');
            
            if (tabName === 'teacher') {
                teacherTab.className = 'px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 bg-white text-purple-600 shadow-lg';
                studentTab.className = 'px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 text-gray-600 hover:text-purple-600';
                teacherGuide.classList.remove('hidden');
                studentGuide.classList.add('hidden');
            } else {
                studentTab.className = 'px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 bg-white text-pink-600 shadow-lg';
                teacherTab.className = 'px-8 py-4 rounded-xl text-lg font-semibold transition-all duration-300 text-gray-600 hover:text-purple-600';
                studentGuide.classList.remove('hidden');
                teacherGuide.classList.add('hidden');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            
            try {
                // Wait for Firebase to initialize
                const firebaseInitialized = await initializeFirebase();
                
                if (firebaseInitialized && isFirebaseConnected) {
                    console.log('Firebase connected successfully');
                    
                    // Check for existing authentication state
                    window.onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            try {
                                const userData = await getUserData(user.uid);
                                if (userData) {
                                    currentUser = {
                                        uid: user.uid,
                                        email: user.email,
                                        name: userData.name,
                                        role: userData.role
                                    };
                                    updateNavigation();
                                    await showAdminDashboard();
                                    return;
                                }
                            } catch (error) {
                                console.error('Error loading user data:', error);
                            }
                        }
                        showWelcome();
                    });
                } else {
                    console.error('Firebase initialization failed');
                    showNotification('ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบการตั้งค่า', 'error');
                    showWelcome();
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus(false);
                showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message, 'error');
                showWelcome();
            } finally {
                hideLoading();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972f8ba1c184f4cf',t:'MTc1NTgzNjA4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
